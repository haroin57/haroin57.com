[
  {
    "slug": "distributed-system",
    "productSlug": "distributed-system",
    "title": "distributed-system - 分散システムの学習実装",
    "summary": "RaftアルゴリズムとgRPC通信を使った分散システムの実装について",
    "createdAt": "2025-12-18",
    "tags": [
      "Java",
      "Distributed Computing",
      "Raft",
      "gRPC"
    ],
    "html": "<h2 id=\"目次\">目次</h2>\n<div class=\"toc-box\"><ul>\n<li><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></li>\n<li><a href=\"#%E6%8A%80%E8%A1%93%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF\">技術スタック</a></li>\n<li><a href=\"#%E8%A8%80%E8%AA%9E%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0\">言語・ランタイム</a></li>\n<li><a href=\"#%E9%80%9A%E4%BF%A1\">通信</a></li>\n<li><a href=\"#%E3%81%9D%E3%81%AE%E4%BB%96\">その他</a></li>\n<li><a href=\"#raft%E3%82%B3%E3%83%B3%E3%82%BB%E3%83%B3%E3%82%B5%E3%82%B9%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%A8%E3%81%AF\">Raftコンセンサスアルゴリズムとは</a></li>\n<li><a href=\"#%E3%81%AA%E3%81%9Craft%E3%81%8B\">なぜRaftか</a></li>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3\">システムアーキテクチャ</a></li>\n<li><a href=\"#%E5%AE%9F%E8%A3%85%E3%81%97%E3%81%9F%E5%86%85%E5%AE%B9\">実装した内容</a></li>\n<li><a href=\"#1-%E3%83%8E%E3%83%BC%E3%83%89%E3%81%AE%E7%8A%B6%E6%85%8B%E9%81%B7%E7%A7%BB\">1. ノードの状態遷移</a></li>\n<li><a href=\"#%E5%AE%9F%E8%A3%85%E3%82%B3%E3%83%BC%E3%83%89\">実装コード</a></li>\n<li><a href=\"#2-%E3%83%AA%E3%83%BC%E3%83%80%E3%83%BC%E9%81%B8%E5%87%BA-leader-election\">2. リーダー選出 (Leader Election)</a></li>\n<li><a href=\"#%E3%81%AA%E3%81%9C%E3%83%A9%E3%83%B3%E3%83%80%E3%83%A0%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E3%81%8B\">なぜランダムタイムアウトか</a></li>\n<li><a href=\"#%E9%81%B8%E6%8C%99%E3%81%AE%E5%AE%9F%E8%A3%85\">選挙の実装</a></li>\n<li><a href=\"#3-%E3%83%AD%E3%82%B0%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3-log-replication\">3. ログレプリケーション (Log Replication)</a></li>\n<li><a href=\"#%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%B5%81%E3%82%8C\">レプリケーションの流れ</a></li>\n<li><a href=\"#%E5%AE%9F%E8%A3%85%E3%82%B3%E3%83%BC%E3%83%89-1\">実装コード</a></li>\n<li><a href=\"#4-grpc%E3%81%AB%E3%82%88%E3%82%8B%E3%83%8E%E3%83%BC%E3%83%89%E9%96%93%E9%80%9A%E4%BF%A1\">4. gRPCによるノード間通信</a></li>\n<li><a href=\"#protocol-buffers%E5%AE%9A%E7%BE%A9\">Protocol Buffers定義</a></li>\n<li><a href=\"#grpc-%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E5%AE%9F%E8%A3%85\">gRPC サーバー実装</a></li>\n<li><a href=\"#5-%E5%88%86%E6%95%A3%E3%82%AD%E3%83%BC%E3%83%90%E3%83%AA%E3%83%A5%E3%83%BC%E3%82%B9%E3%83%88%E3%82%A2\">5. 分散キーバリューストア</a></li>\n<li><a href=\"#6-%E9%9A%9C%E5%AE%B3%E6%A4%9C%E7%9F%A5%E3%81%A8%E3%83%95%E3%82%A7%E3%82%A4%E3%83%AB%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC\">6. 障害検知とフェイルオーバー</a></li>\n<li><a href=\"#%E5%AD%A6%E3%82%93%E3%81%A0%E3%81%93%E3%81%A8\">学んだこと</a></li>\n<li><a href=\"#cap%E5%AE%9A%E7%90%86%E3%81%AE%E5%AE%9F%E6%84%9F\">CAP定理の実感</a></li>\n<li><a href=\"#%E5%88%86%E6%95%A3%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E7%89%B9%E6%9C%89%E3%81%AE%E9%9B%A3%E3%81%97%E3%81%95\">分散システム特有の難しさ</a></li>\n<li><a href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E5%A4%A7%E5%A4%89%E3%81%95\">デバッグの大変さ</a></li>\n<li><a href=\"#%E3%83%86%E3%82%B9%E3%83%88\">テスト</a></li>\n<li><a href=\"#%E5%8D%98%E4%BD%93%E3%83%86%E3%82%B9%E3%83%88\">単体テスト</a></li>\n<li><a href=\"#%E7%B5%B1%E5%90%88%E3%83%86%E3%82%B9%E3%83%88\">統合テスト</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99\">参考資料</a></li>\n<li><a href=\"#%E4%BB%8A%E5%BE%8C%E3%81%AE%E6%94%B9%E5%96%84%E4%BA%88%E5%AE%9A\">今後の改善予定</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul></div>\n<br>\n<h2 id=\"はじめに\">はじめに</h2>\n<p>分散システムの理論を実際に手を動かして理解するために作ったプロジェクトです。</p>\n<p>Raftコンセンサスアルゴリズムを中心に、分散合意やレプリケーションの仕組みを実装しています。「論文を読んだだけでは分からない」部分を実装を通じて理解することを目的としています。</p>\n<br>\n<h2 id=\"技術スタック\">技術スタック</h2>\n<br>\n<h3 id=\"言語ランタイム\">言語・ランタイム</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>Java 21</strong></td><td>Virtual Threadsを活用した並行処理</td></tr><tr><td><strong>Gradle</strong></td><td>ビルドツール・依存関係管理</td></tr></tbody></table></div>\n<br>\n<h3 id=\"通信\">通信</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>gRPC</strong></td><td>高速なノード間RPC通信</td></tr><tr><td><strong>Protocol Buffers</strong></td><td>効率的なシリアライズフォーマット</td></tr></tbody></table></div>\n<br>\n<h3 id=\"その他\">その他</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>SLF4J + Logback</strong></td><td>ロギング</td></tr><tr><td><strong>JUnit 5</strong></td><td>テスト</td></tr></tbody></table></div>\n<br>\n<h2 id=\"raftコンセンサスアルゴリズムとは\">Raftコンセンサスアルゴリズムとは</h2>\n<p>Raftは分散システムにおける<strong>合意形成（コンセンサス）</strong>を実現するアルゴリズムです。</p>\n<p>複数のサーバー（ノード）が同じ状態を持つように調整し、一部のノードが故障しても全体として正しく動作し続けることを保証します。</p>\n<br>\n<h3 id=\"なぜraftか\">なぜRaftか</h3>\n<p>以前から有名なPaxosアルゴリズムは理解が難しいことで知られています。Raftは「理解しやすさ」を設計目標に掲げ、以下の特徴を持ちます：</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>特徴</th><th>説明</th></tr></thead><tbody><tr><td><strong>強いリーダー</strong></td><td>ログはリーダーからフォロワーへ一方向にのみ流れる</td></tr><tr><td><strong>リーダー選出</strong></td><td>ランダム化タイムアウトで選出の衝突を回避</td></tr><tr><td><strong>メンバーシップ変更</strong></td><td>Joint Consensusによる安全な構成変更</td></tr></tbody></table></div>\n<br>\n<h2 id=\"システムアーキテクチャ\">システムアーキテクチャ</h2>\n<div class=\"mermaid-block\" data-mermaid=\"flowchart TB\n    subgraph Cluster[&#x22;Raft Cluster (3 or 5 nodes)&#x22;]\n        Leader[&#x22;Node A<br/>(Leader)&#x22;]\n        Follower1[&#x22;Node B<br/>(Follower)&#x22;]\n        Follower2[&#x22;Node C<br/>(Follower)&#x22;]\n    end\n\n    subgraph ClientLayer[&#x22;Client&#x22;]\n        Client[&#x22;KV操作<br/>get, put, delete&#x22;]\n    end\n\n    Client -->|リクエスト| Leader\n    Leader -->|レプリケーション| Follower1\n    Leader -->|レプリケーション| Follower2\n    Leader -->|レスポンス| Client\n    Follower1 -.->|Heartbeat応答| Leader\n    Follower2 -.->|Heartbeat応答| Leader\n\n    style Leader fill:#134e4a,stroke:#5eead4,stroke-width:2px\n    style Client fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px\"></div>\n<br>\n<h2 id=\"実装した内容\">実装した内容</h2>\n<br>\n<h3 id=\"1-ノードの状態遷移\">1. ノードの状態遷移</h3>\n<p>Raftのノードは3つの状態を持ちます：</p>\n<div class=\"mermaid-block\" data-mermaid=\"stateDiagram-v2\n    [*] --> Follower\n    Follower --> Candidate: 選挙タイムアウト\n    Candidate --> Leader: 過半数の票を獲得\n    Candidate --> Follower: 他のリーダーを発見\n    Leader --> Follower: 他のリーダーを発見\n    Candidate --> Candidate: 投票の分裂\n\n    classDef leader fill:#134e4a,stroke:#5eead4,stroke-width:2px\n    classDef candidate fill:#78350f,stroke:#fbbf24,stroke-width:2px\n    classDef follower fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px\n\n    class Leader leader\n    class Candidate candidate\n    class Follower follower\"></div>\n<br>\n<h4 id=\"実装コード\">実装コード</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> enum</span><span style=\"color:#F69D50\"> NodeState</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">    FOLLOWER</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">    CANDIDATE</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">    LEADER</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> class</span><span style=\"color:#F69D50\"> RaftNode</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> volatile</span><span style=\"color:#ADBAC7\"> NodeState</span><span style=\"color:#ADBAC7\"> state</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> NodeState.FOLLOWER;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> volatile</span><span style=\"color:#F47067\"> int</span><span style=\"color:#ADBAC7\"> currentTerm</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 0</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> volatile</span><span style=\"color:#ADBAC7\"> String</span><span style=\"color:#ADBAC7\"> votedFor</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> null</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#ADBAC7\"> String</span><span style=\"color:#ADBAC7\"> nodeId;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#ADBAC7\"> List</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">String</span><span style=\"color:#F69D50\">> </span><span style=\"color:#ADBAC7\">peers;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // リーダーからのハートビートを受信したとき</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#F47067\"> synchronized</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> onHeartbeatReceived</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#F47067\">int</span><span style=\"color:#F69D50\"> leaderTerm</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        if</span><span style=\"color:#ADBAC7\"> (leaderTerm </span><span style=\"color:#F47067\">>=</span><span style=\"color:#ADBAC7\"> currentTerm) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            currentTerm </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> leaderTerm;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            state </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> NodeState.FOLLOWER;</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">            resetElectionTimer</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 選挙タイムアウトが発生したとき</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#F47067\"> synchronized</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> onElectionTimeout</span><span style=\"color:#ADBAC7\">() {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        if</span><span style=\"color:#ADBAC7\"> (state </span><span style=\"color:#F47067\">!=</span><span style=\"color:#ADBAC7\"> NodeState.LEADER) {</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">            startElection</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"2-リーダー選出-leader-election\">2. リーダー選出 (Leader Election)</h3>\n<p>選挙プロセスの流れ：</p>\n<ol>\n<li><strong>選挙タイムアウト</strong>発生 → Followerが<strong>Candidate</strong>に遷移</li>\n<li><strong>Term（任期）をインクリメント</strong></li>\n<li><strong>自分に投票</strong> + 他ノードに<strong>RequestVote RPC</strong>を送信</li>\n<li><strong>過半数の票</strong>を獲得 → <strong>Leader</strong>に遷移</li>\n<li>他のLeaderを発見 → <strong>Follower</strong>に戻る</li>\n</ol>\n<br>\n<h4 id=\"なぜランダムタイムアウトか\">なぜランダムタイムアウトか</h4>\n<p>選挙タイムアウトを150-300msの範囲でランダムに設定することで、複数ノードが同時にCandidateになる確率を下げています。これにより<strong>Split Vote(票の分散)</strong>を回避できます。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">private</span><span style=\"color:#F47067\"> static</span><span style=\"color:#F47067\"> final</span><span style=\"color:#F47067\"> int</span><span style=\"color:#ADBAC7\"> ELECTION_TIMEOUT_MIN_MS</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 150</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">private</span><span style=\"color:#F47067\"> static</span><span style=\"color:#F47067\"> final</span><span style=\"color:#F47067\"> int</span><span style=\"color:#ADBAC7\"> ELECTION_TIMEOUT_MAX_MS</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 300</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">private</span><span style=\"color:#F47067\"> int</span><span style=\"color:#DCBDFB\"> getRandomElectionTimeout</span><span style=\"color:#ADBAC7\">() {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#ADBAC7\"> ThreadLocalRandom.</span><span style=\"color:#DCBDFB\">current</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">nextInt</span><span style=\"color:#ADBAC7\">(ELECTION_TIMEOUT_MIN_MS, ELECTION_TIMEOUT_MAX_MS </span><span style=\"color:#F47067\">+</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h4 id=\"選挙の実装\">選挙の実装</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> startElection</span><span style=\"color:#ADBAC7\">() {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    state </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> NodeState.CANDIDATE;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    currentTerm</span><span style=\"color:#F47067\">++</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    votedFor </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> nodeId;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int</span><span style=\"color:#ADBAC7\"> votes</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">; </span><span style=\"color:#768390\">// 自分への投票</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    log.</span><span style=\"color:#DCBDFB\">info</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"Node {} starting election for term {}\"</span><span style=\"color:#ADBAC7\">, nodeId, currentTerm);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // Virtual Threadsで並行にRequestVoteを送信</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    List</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#ADBAC7\">CompletableFuture</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">Boolean</span><span style=\"color:#F69D50\">>> </span><span style=\"color:#ADBAC7\">futures</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> peers.</span><span style=\"color:#DCBDFB\">stream</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">map</span><span style=\"color:#ADBAC7\">(peer </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> CompletableFuture.</span><span style=\"color:#DCBDFB\">supplyAsync</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">            try</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                RequestVoteResponse</span><span style=\"color:#ADBAC7\"> response</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> sendRequestVote</span><span style=\"color:#ADBAC7\">(peer,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    RequestVoteRequest.</span><span style=\"color:#DCBDFB\">newBuilder</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                        .</span><span style=\"color:#DCBDFB\">setTerm</span><span style=\"color:#ADBAC7\">(currentTerm)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                        .</span><span style=\"color:#DCBDFB\">setCandidateId</span><span style=\"color:#ADBAC7\">(nodeId)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                        .</span><span style=\"color:#DCBDFB\">setLastLogIndex</span><span style=\"color:#ADBAC7\">(log.</span><span style=\"color:#DCBDFB\">getLastIndex</span><span style=\"color:#ADBAC7\">())</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                        .</span><span style=\"color:#DCBDFB\">setLastLogTerm</span><span style=\"color:#ADBAC7\">(log.</span><span style=\"color:#DCBDFB\">getLastTerm</span><span style=\"color:#ADBAC7\">())</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                        .</span><span style=\"color:#DCBDFB\">build</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                );</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">                return</span><span style=\"color:#ADBAC7\"> response.</span><span style=\"color:#DCBDFB\">getVoteGranted</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            } </span><span style=\"color:#F47067\">catch</span><span style=\"color:#ADBAC7\"> (Exception </span><span style=\"color:#F69D50\">e</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                log.</span><span style=\"color:#DCBDFB\">warn</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"Failed to get vote from {}\"</span><span style=\"color:#ADBAC7\">, peer, e);</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">                return</span><span style=\"color:#6CB6FF\"> false</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        }, executor))</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">toList</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 結果を集計</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    for</span><span style=\"color:#ADBAC7\"> (CompletableFuture</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">Boolean</span><span style=\"color:#F69D50\">> </span><span style=\"color:#ADBAC7\">future</span><span style=\"color:#F47067\"> :</span><span style=\"color:#ADBAC7\"> futures) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        try</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">            if</span><span style=\"color:#ADBAC7\"> (future.</span><span style=\"color:#DCBDFB\">get</span><span style=\"color:#ADBAC7\">(ELECTION_TIMEOUT_MIN_MS, TimeUnit.MILLISECONDS)) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                votes</span><span style=\"color:#F47067\">++</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        } </span><span style=\"color:#F47067\">catch</span><span style=\"color:#ADBAC7\"> (Exception </span><span style=\"color:#F69D50\">e</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">            // タイムアウトまたは失敗</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 過半数の票を獲得したらLeaderに</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    if</span><span style=\"color:#ADBAC7\"> (votes </span><span style=\"color:#F47067\">></span><span style=\"color:#ADBAC7\"> (peers.</span><span style=\"color:#DCBDFB\">size</span><span style=\"color:#ADBAC7\">() </span><span style=\"color:#F47067\">+</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">) </span><span style=\"color:#F47067\">/</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">        becomeLeader</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">private</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> becomeLeader</span><span style=\"color:#ADBAC7\">() {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    state </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> NodeState.LEADER;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    log.</span><span style=\"color:#DCBDFB\">info</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"Node {} became leader for term {}\"</span><span style=\"color:#ADBAC7\">, nodeId, currentTerm);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 全Followerのnext/matchIndexを初期化</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    for</span><span style=\"color:#ADBAC7\"> (String</span><span style=\"color:#ADBAC7\"> peer</span><span style=\"color:#F47067\"> :</span><span style=\"color:#ADBAC7\"> peers) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        nextIndex.</span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(peer, log.</span><span style=\"color:#DCBDFB\">getLastIndex</span><span style=\"color:#ADBAC7\">() </span><span style=\"color:#F47067\">+</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        matchIndex.</span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(peer, </span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // ハートビート送信開始</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    startHeartbeat</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"3-ログレプリケーション-log-replication\">3. ログレプリケーション (Log Replication)</h3>\n<p>クライアントからの書き込み要求をログとして全ノードに複製する仕組みです。</p>\n<br>\n<h4 id=\"レプリケーションの流れ\">レプリケーションの流れ</h4>\n<div class=\"mermaid-block\" data-mermaid=\"sequenceDiagram\n    participant C as Client\n    participant L as Leader\n    participant FA as Follower A\n    participant FB as Follower B\n\n    C->>L: PUT(key, val)\n    L->>FA: AppendEntries\n    L->>FB: AppendEntries\n    FA-->>L: Success\n    FB-->>L: Success\n    L->>C: OK (コミット完了)\n    L-->>FB: Heartbeat\"></div>\n<br>\n<h4 id=\"実装コード-1\">実装コード</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> class</span><span style=\"color:#F69D50\"> LogEntry</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#F47067\"> int</span><span style=\"color:#ADBAC7\"> term;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#F47067\"> int</span><span style=\"color:#ADBAC7\"> index;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#ADBAC7\"> Command</span><span style=\"color:#ADBAC7\"> command;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#DCBDFB\"> LogEntry</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#F47067\">int</span><span style=\"color:#F69D50\"> term</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#F47067\">int</span><span style=\"color:#F69D50\"> index</span><span style=\"color:#ADBAC7\">, Command </span><span style=\"color:#F69D50\">command</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">        this</span><span style=\"color:#ADBAC7\">.term </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> term;</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">        this</span><span style=\"color:#ADBAC7\">.index </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> index;</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">        this</span><span style=\"color:#ADBAC7\">.command </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> command;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#ADBAC7\"> CompletableFuture</span><span style=\"color:#F47067\">&#x3C;</span><span style=\"color:#ADBAC7\">Boolean</span><span style=\"color:#F47067\">></span><span style=\"color:#DCBDFB\"> appendEntry</span><span style=\"color:#ADBAC7\">(Command command) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    if</span><span style=\"color:#ADBAC7\"> (state </span><span style=\"color:#F47067\">!=</span><span style=\"color:#ADBAC7\"> NodeState.LEADER) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        return</span><span style=\"color:#ADBAC7\"> CompletableFuture.</span><span style=\"color:#DCBDFB\">completedFuture</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">false</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // ログにエントリを追加</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    LogEntry</span><span style=\"color:#ADBAC7\"> entry</span><span style=\"color:#F47067\"> =</span><span style=\"color:#F47067\"> new</span><span style=\"color:#DCBDFB\"> LogEntry</span><span style=\"color:#ADBAC7\">(currentTerm, log.</span><span style=\"color:#DCBDFB\">getLastIndex</span><span style=\"color:#ADBAC7\">() </span><span style=\"color:#F47067\">+</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">, command);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    log.</span><span style=\"color:#DCBDFB\">append</span><span style=\"color:#ADBAC7\">(entry);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // Virtual Threadsで並行にAppendEntriesを送信</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    AtomicInteger</span><span style=\"color:#ADBAC7\"> acks</span><span style=\"color:#F47067\"> =</span><span style=\"color:#F47067\"> new</span><span style=\"color:#DCBDFB\"> AtomicInteger</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">); </span><span style=\"color:#768390\">// 自分はすでにOK</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    List</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#ADBAC7\">CompletableFuture</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">Void</span><span style=\"color:#F69D50\">>> </span><span style=\"color:#ADBAC7\">futures</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> peers.</span><span style=\"color:#DCBDFB\">stream</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">map</span><span style=\"color:#ADBAC7\">(peer </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> CompletableFuture.</span><span style=\"color:#DCBDFB\">runAsync</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">            try</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                AppendEntriesResponse</span><span style=\"color:#ADBAC7\"> response</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> sendAppendEntries</span><span style=\"color:#ADBAC7\">(peer, entry);</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">                if</span><span style=\"color:#ADBAC7\"> (response.</span><span style=\"color:#DCBDFB\">getSuccess</span><span style=\"color:#ADBAC7\">()) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    acks.</span><span style=\"color:#DCBDFB\">incrementAndGet</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    nextIndex.</span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(peer, entry.</span><span style=\"color:#DCBDFB\">getIndex</span><span style=\"color:#ADBAC7\">() </span><span style=\"color:#F47067\">+</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    matchIndex.</span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(peer, entry.</span><span style=\"color:#DCBDFB\">getIndex</span><span style=\"color:#ADBAC7\">());</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                } </span><span style=\"color:#F47067\">else</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">                    // ログの不整合 → nextIndexをデクリメントしてリトライ</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    nextIndex.</span><span style=\"color:#DCBDFB\">compute</span><span style=\"color:#ADBAC7\">(peer, (k, v) </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> Math.</span><span style=\"color:#DCBDFB\">max</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">, v </span><span style=\"color:#F47067\">-</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">));</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            } </span><span style=\"color:#F47067\">catch</span><span style=\"color:#ADBAC7\"> (Exception </span><span style=\"color:#F69D50\">e</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                log.</span><span style=\"color:#DCBDFB\">warn</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"Failed to replicate to {}\"</span><span style=\"color:#ADBAC7\">, peer, e);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        }, executor))</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">toList</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 結果を待機</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#ADBAC7\"> CompletableFuture.</span><span style=\"color:#DCBDFB\">allOf</span><span style=\"color:#ADBAC7\">(futures.</span><span style=\"color:#DCBDFB\">toArray</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#F47067\">new</span><span style=\"color:#F47067\"> CompletableFuture</span><span style=\"color:#ADBAC7\">[</span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">]))</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">thenApply</span><span style=\"color:#ADBAC7\">(v </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">            // 過半数がACKしたらコミット</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">            if</span><span style=\"color:#ADBAC7\"> (acks.</span><span style=\"color:#DCBDFB\">get</span><span style=\"color:#ADBAC7\">() </span><span style=\"color:#F47067\">></span><span style=\"color:#ADBAC7\"> (peers.</span><span style=\"color:#DCBDFB\">size</span><span style=\"color:#ADBAC7\">() </span><span style=\"color:#F47067\">+</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">) </span><span style=\"color:#F47067\">/</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                commitIndex </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> entry.</span><span style=\"color:#DCBDFB\">getIndex</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">                applyToStateMachine</span><span style=\"color:#ADBAC7\">(entry);</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">                return</span><span style=\"color:#6CB6FF\"> true</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">            return</span><span style=\"color:#6CB6FF\"> false</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        });</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"4-grpcによるノード間通信\">4. gRPCによるノード間通信</h3>\n<p>Protocol Buffersでメッセージを定義し、gRPCでRPCを実装しています。</p>\n<br>\n<h4 id=\"protocol-buffers定義\">Protocol Buffers定義</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Proto</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"protobuf\" data-theme=\"github-dark-dimmed\"><code data-language=\"protobuf\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">syntax</span><span style=\"color:#F47067\"> =</span><span style=\"color:#96D0FF\"> \"proto3\"</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">package</span><span style=\"color:#96D0FF\"> raft</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">option</span><span style=\"color:#6CB6FF\"> java_package</span><span style=\"color:#F47067\"> =</span><span style=\"color:#96D0FF\"> \"com.haroin57.raft.proto\"</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">option</span><span style=\"color:#6CB6FF\"> java_multiple_files</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> true</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">service</span><span style=\"color:#F69D50\"> RaftService</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 投票要求</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    rpc</span><span style=\"color:#DCBDFB\"> RequestVote</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#F69D50\">RequestVoteRequest</span><span style=\"color:#ADBAC7\">) </span><span style=\"color:#F47067\">returns</span><span style=\"color:#ADBAC7\"> (</span><span style=\"color:#F69D50\">RequestVoteResponse</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // ログ追加（ハートビートも兼用）</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    rpc</span><span style=\"color:#DCBDFB\"> AppendEntries</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#F69D50\">AppendEntriesRequest</span><span style=\"color:#ADBAC7\">) </span><span style=\"color:#F47067\">returns</span><span style=\"color:#ADBAC7\"> (</span><span style=\"color:#F69D50\">AppendEntriesResponse</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">message</span><span style=\"color:#F69D50\"> RequestVoteRequest</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    string</span><span style=\"color:#ADBAC7\"> candidate_id </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> last_log_index </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 3</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> last_log_term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 4</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">message</span><span style=\"color:#F69D50\"> RequestVoteResponse</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    bool</span><span style=\"color:#ADBAC7\"> vote_granted </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">message</span><span style=\"color:#F69D50\"> LogEntry</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> index </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    bytes</span><span style=\"color:#ADBAC7\"> command </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 3</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">message</span><span style=\"color:#F69D50\"> AppendEntriesRequest</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    string</span><span style=\"color:#ADBAC7\"> leader_id </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> prev_log_index </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 3</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> prev_log_term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 4</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    repeated</span><span style=\"color:#F47067\"> LogEntry</span><span style=\"color:#ADBAC7\"> entries </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 5</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> leader_commit </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 6</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">message</span><span style=\"color:#F69D50\"> AppendEntriesResponse</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    int32</span><span style=\"color:#ADBAC7\"> term </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    bool</span><span style=\"color:#ADBAC7\"> success </span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h4 id=\"grpc-サーバー実装\">gRPC サーバー実装</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> class</span><span style=\"color:#F69D50\"> RaftServiceImpl</span><span style=\"color:#F47067\"> extends</span><span style=\"color:#6CB6FF\"> RaftServiceGrpc.RaftServiceImplBase</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#ADBAC7\"> RaftNode</span><span style=\"color:#ADBAC7\"> node;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    @</span><span style=\"color:#F47067\">Override</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> requestVote</span><span style=\"color:#ADBAC7\">(RequestVoteRequest </span><span style=\"color:#F69D50\">request</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                           StreamObserver&#x3C;</span><span style=\"color:#F47067\">RequestVoteResponse</span><span style=\"color:#ADBAC7\">> </span><span style=\"color:#F69D50\">responseObserver</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        boolean</span><span style=\"color:#ADBAC7\"> granted</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> node.</span><span style=\"color:#DCBDFB\">handleRequestVote</span><span style=\"color:#ADBAC7\">(</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getTerm</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getCandidateId</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getLastLogIndex</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getLastLogTerm</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        );</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        responseObserver.</span><span style=\"color:#DCBDFB\">onNext</span><span style=\"color:#ADBAC7\">(RequestVoteResponse.</span><span style=\"color:#DCBDFB\">newBuilder</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">setTerm</span><span style=\"color:#ADBAC7\">(node.</span><span style=\"color:#DCBDFB\">getCurrentTerm</span><span style=\"color:#ADBAC7\">())</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">setVoteGranted</span><span style=\"color:#ADBAC7\">(granted)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">build</span><span style=\"color:#ADBAC7\">());</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        responseObserver.</span><span style=\"color:#DCBDFB\">onCompleted</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    @</span><span style=\"color:#F47067\">Override</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> appendEntries</span><span style=\"color:#ADBAC7\">(AppendEntriesRequest </span><span style=\"color:#F69D50\">request</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                             StreamObserver&#x3C;</span><span style=\"color:#F47067\">AppendEntriesResponse</span><span style=\"color:#ADBAC7\">> </span><span style=\"color:#F69D50\">responseObserver</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        boolean</span><span style=\"color:#ADBAC7\"> success</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> node.</span><span style=\"color:#DCBDFB\">handleAppendEntries</span><span style=\"color:#ADBAC7\">(</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getTerm</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getLeaderId</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getPrevLogIndex</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getPrevLogTerm</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getEntriesList</span><span style=\"color:#ADBAC7\">(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            request.</span><span style=\"color:#DCBDFB\">getLeaderCommit</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        );</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        responseObserver.</span><span style=\"color:#DCBDFB\">onNext</span><span style=\"color:#ADBAC7\">(AppendEntriesResponse.</span><span style=\"color:#DCBDFB\">newBuilder</span><span style=\"color:#ADBAC7\">()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">setTerm</span><span style=\"color:#ADBAC7\">(node.</span><span style=\"color:#DCBDFB\">getCurrentTerm</span><span style=\"color:#ADBAC7\">())</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">setSuccess</span><span style=\"color:#ADBAC7\">(success)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">build</span><span style=\"color:#ADBAC7\">());</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        responseObserver.</span><span style=\"color:#DCBDFB\">onCompleted</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"5-分散キーバリューストア\">5. 分散キーバリューストア</h3>\n<p>Raftの上にシンプルなKVストアを構築しています。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> interface</span><span style=\"color:#F69D50\"> KeyValueStore</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    CompletableFuture&#x3C;</span><span style=\"color:#F47067\">Void</span><span style=\"color:#ADBAC7\">> </span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(String </span><span style=\"color:#F69D50\">key</span><span style=\"color:#ADBAC7\">, String </span><span style=\"color:#F69D50\">value</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    String </span><span style=\"color:#DCBDFB\">get</span><span style=\"color:#ADBAC7\">(String </span><span style=\"color:#F69D50\">key</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    CompletableFuture&#x3C;</span><span style=\"color:#F47067\">Void</span><span style=\"color:#ADBAC7\">> </span><span style=\"color:#DCBDFB\">delete</span><span style=\"color:#ADBAC7\">(String </span><span style=\"color:#F69D50\">key</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">public</span><span style=\"color:#F47067\"> class</span><span style=\"color:#F69D50\"> RaftKeyValueStore</span><span style=\"color:#F47067\"> implements</span><span style=\"color:#6CB6FF\"> KeyValueStore</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#ADBAC7\"> RaftNode</span><span style=\"color:#ADBAC7\"> raftNode;</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    private</span><span style=\"color:#F47067\"> final</span><span style=\"color:#ADBAC7\"> ConcurrentHashMap</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">String</span><span style=\"color:#F69D50\">, </span><span style=\"color:#F47067\">String</span><span style=\"color:#F69D50\">> </span><span style=\"color:#ADBAC7\">data</span><span style=\"color:#F47067\"> =</span><span style=\"color:#F47067\"> new</span><span style=\"color:#ADBAC7\"> ConcurrentHashMap&#x3C;>();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    @</span><span style=\"color:#F47067\">Override</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#ADBAC7\"> CompletableFuture&#x3C;</span><span style=\"color:#F47067\">Void</span><span style=\"color:#ADBAC7\">> </span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(String </span><span style=\"color:#F69D50\">key</span><span style=\"color:#ADBAC7\">, String </span><span style=\"color:#F69D50\">value</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        Command</span><span style=\"color:#ADBAC7\"> cmd</span><span style=\"color:#F47067\"> =</span><span style=\"color:#F47067\"> new</span><span style=\"color:#DCBDFB\"> PutCommand</span><span style=\"color:#ADBAC7\">(key, value);</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        return</span><span style=\"color:#ADBAC7\"> raftNode.</span><span style=\"color:#DCBDFB\">appendEntry</span><span style=\"color:#ADBAC7\">(cmd)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            .</span><span style=\"color:#DCBDFB\">thenAccept</span><span style=\"color:#ADBAC7\">(success </span><span style=\"color:#F47067\">-></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">                if</span><span style=\"color:#ADBAC7\"> (</span><span style=\"color:#F47067\">!</span><span style=\"color:#ADBAC7\">success) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">                    throw</span><span style=\"color:#F47067\"> new</span><span style=\"color:#DCBDFB\"> NotLeaderException</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            });</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    @</span><span style=\"color:#F47067\">Override</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#ADBAC7\"> String </span><span style=\"color:#DCBDFB\">get</span><span style=\"color:#ADBAC7\">(String </span><span style=\"color:#F69D50\">key</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">        // 読み取りはローカルから（Follower Readの場合）</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">        // 強い一貫性が必要な場合はLeader経由</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        return</span><span style=\"color:#ADBAC7\"> data.</span><span style=\"color:#DCBDFB\">get</span><span style=\"color:#ADBAC7\">(key);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // ステートマシンへの適用</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    public</span><span style=\"color:#F47067\"> void</span><span style=\"color:#DCBDFB\"> apply</span><span style=\"color:#ADBAC7\">(Command </span><span style=\"color:#F69D50\">command</span><span style=\"color:#ADBAC7\">) {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        if</span><span style=\"color:#ADBAC7\"> (command </span><span style=\"color:#F47067\">instanceof</span><span style=\"color:#ADBAC7\"> PutCommand put) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            data.</span><span style=\"color:#DCBDFB\">put</span><span style=\"color:#ADBAC7\">(put.</span><span style=\"color:#DCBDFB\">getKey</span><span style=\"color:#ADBAC7\">(), put.</span><span style=\"color:#DCBDFB\">getValue</span><span style=\"color:#ADBAC7\">());</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        } </span><span style=\"color:#F47067\">else</span><span style=\"color:#F47067\"> if</span><span style=\"color:#ADBAC7\"> (command </span><span style=\"color:#F47067\">instanceof</span><span style=\"color:#ADBAC7\"> DeleteCommand delete) {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            data.</span><span style=\"color:#DCBDFB\">remove</span><span style=\"color:#ADBAC7\">(delete.</span><span style=\"color:#DCBDFB\">getKey</span><span style=\"color:#ADBAC7\">());</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"6-障害検知とフェイルオーバー\">6. 障害検知とフェイルオーバー</h3>\n<p>ノードの障害を検知して自動的にリーダーを再選出します。</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>パラメータ</th><th>値</th><th>説明</th></tr></thead><tbody><tr><td>Heartbeat間隔</td><td>50ms</td><td>Leaderが送信する間隔</td></tr><tr><td>選挙タイムアウト</td><td>150-300ms</td><td>ランダム化して衝突回避</td></tr><tr><td>RPC タイムアウト</td><td>100ms</td><td>通信タイムアウト</td></tr></tbody></table></div>\n<br>\n<h2 id=\"学んだこと\">学んだこと</h2>\n<br>\n<h3 id=\"cap定理の実感\">CAP定理の実感</h3>\n<p>分散システムでは「一貫性（Consistency）」「可用性（Availability）」「分断耐性（Partition Tolerance）」のうち2つしか同時に満たせません。</p>\n<p>Raftは<strong>CP(一貫性 + 分断耐性)</strong>を選択しています：</p>\n<ul>\n<li>過半数のノードが利用不可 → 書き込み停止</li>\n<li>データの一貫性は常に保証</li>\n</ul>\n<div class=\"mermaid-block\" data-mermaid=\"flowchart TB\n    C[&#x22;<strong>Consistency</strong><br/>一貫性&#x22;]\n    A[&#x22;Availability<br/>可用性&#x22;]\n    P[&#x22;<strong>Partition Tolerance</strong><br/>分断耐性&#x22;]\n\n    C ---|&#x22;Raft&#x22;| P\n    C -.-|&#x22;×&#x22;| A\n    A -.-|&#x22;×&#x22;| P\n\n    style C fill:#134e4a,stroke:#5eead4,stroke-width:2px\n    style P fill:#134e4a,stroke:#5eead4,stroke-width:2px\"></div>\n<br>\n<h3 id=\"分散システム特有の難しさ\">分散システム特有の難しさ</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>課題</th><th>説明</th></tr></thead><tbody><tr><td><strong>ネットワーク遅延</strong></td><td>メッセージの到着順序が保証されない</td></tr><tr><td><strong>ネットワーク分断</strong></td><td>一部のノードと通信不能になる</td></tr><tr><td><strong>クロックの同期</strong></td><td>各ノードの時計がずれる</td></tr><tr><td><strong>障害の種類</strong></td><td>クラッシュ、ビザンチン障害など</td></tr><tr><td><strong>再試行の冪等性</strong></td><td>同じ操作を複数回実行しても結果が変わらない設計</td></tr></tbody></table></div>\n<br>\n<h3 id=\"デバッグの大変さ\">デバッグの大変さ</h3>\n<p>複数ノードが非同期に動作するため、バグの再現が困難です。</p>\n<p>対策として実施したこと：</p>\n<ol>\n<li><strong>詳細なログ出力</strong> - イベントの順序を追跡</li>\n<li><strong>論理クロック</strong> - 因果関係を把握</li>\n<li><strong>決定論的テスト</strong> - 乱数シードを固定</li>\n</ol>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#768390\">// イベントログの例</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">log.</span><span style=\"color:#DCBDFB\">info</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"[Term={}][Node={}][State={}] {}\"</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    currentTerm, nodeId, state, </span><span style=\"color:#96D0FF\">\"Received AppendEntries from \"</span><span style=\"color:#F47067\"> +</span><span style=\"color:#ADBAC7\"> leaderId);</span></span></code></pre></figure>\n<br>\n<h2 id=\"テスト\">テスト</h2>\n<br>\n<h3 id=\"単体テスト\">単体テスト</h3>\n<p>各コンポーネントを個別にテスト：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#ADBAC7\">@</span><span style=\"color:#F47067\">Test</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">void</span><span style=\"color:#DCBDFB\"> shouldGrantVoteIfTermIsHigher</span><span style=\"color:#ADBAC7\">() {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    RaftNode</span><span style=\"color:#ADBAC7\"> node</span><span style=\"color:#F47067\"> =</span><span style=\"color:#F47067\"> new</span><span style=\"color:#DCBDFB\"> RaftNode</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"node1\"</span><span style=\"color:#ADBAC7\">, List.</span><span style=\"color:#DCBDFB\">of</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"node2\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"node3\"</span><span style=\"color:#ADBAC7\">));</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    boolean</span><span style=\"color:#ADBAC7\"> granted</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> node.</span><span style=\"color:#DCBDFB\">handleRequestVote</span><span style=\"color:#ADBAC7\">(</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">        /* term */</span><span style=\"color:#6CB6FF\"> 2</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">        /* candidateId */</span><span style=\"color:#96D0FF\"> \"node2\"</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">        /* lastLogIndex */</span><span style=\"color:#6CB6FF\"> 0</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">        /* lastLogTerm */</span><span style=\"color:#6CB6FF\"> 0</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    );</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    assertThat</span><span style=\"color:#ADBAC7\">(granted).</span><span style=\"color:#DCBDFB\">isTrue</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    assertThat</span><span style=\"color:#ADBAC7\">(node.</span><span style=\"color:#DCBDFB\">getVotedFor</span><span style=\"color:#ADBAC7\">()).</span><span style=\"color:#DCBDFB\">isEqualTo</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"node2\"</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"統合テスト\">統合テスト</h3>\n<p>複数ノードを起動して実際の動作を確認：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Java</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"java\" data-theme=\"github-dark-dimmed\"><code data-language=\"java\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#ADBAC7\">@</span><span style=\"color:#F47067\">Test</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">void</span><span style=\"color:#DCBDFB\"> shouldElectLeaderIn3NodeCluster</span><span style=\"color:#ADBAC7\">() throws Exception {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 3ノードのクラスタを起動</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    List</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">RaftNode</span><span style=\"color:#F69D50\">> </span><span style=\"color:#ADBAC7\">nodes</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> startCluster</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">3</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // リーダーが選出されるまで待機</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    await</span><span style=\"color:#ADBAC7\">().</span><span style=\"color:#DCBDFB\">atMost</span><span style=\"color:#ADBAC7\">(Duration.</span><span style=\"color:#DCBDFB\">ofSeconds</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">5</span><span style=\"color:#ADBAC7\">))</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">until</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">-></span><span style=\"color:#DCBDFB\"> countLeaders</span><span style=\"color:#ADBAC7\">(nodes) </span><span style=\"color:#F47067\">==</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 1つだけリーダーがいることを確認</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    assertThat</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#DCBDFB\">countLeaders</span><span style=\"color:#ADBAC7\">(nodes)).</span><span style=\"color:#DCBDFB\">isEqualTo</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">@</span><span style=\"color:#F47067\">Test</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">void</span><span style=\"color:#DCBDFB\"> shouldReelectLeaderWhenLeaderFails</span><span style=\"color:#ADBAC7\">() throws Exception {</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    List</span><span style=\"color:#F69D50\">&#x3C;</span><span style=\"color:#F47067\">RaftNode</span><span style=\"color:#F69D50\">> </span><span style=\"color:#ADBAC7\">nodes</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> startCluster</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">3</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    await</span><span style=\"color:#ADBAC7\">().</span><span style=\"color:#DCBDFB\">until</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">-></span><span style=\"color:#DCBDFB\"> countLeaders</span><span style=\"color:#ADBAC7\">(nodes) </span><span style=\"color:#F47067\">==</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // リーダーを停止</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    RaftNode</span><span style=\"color:#ADBAC7\"> leader</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> findLeader</span><span style=\"color:#ADBAC7\">(nodes);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    leader.</span><span style=\"color:#DCBDFB\">shutdown</span><span style=\"color:#ADBAC7\">();</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 新しいリーダーが選出されるまで待機</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    await</span><span style=\"color:#ADBAC7\">().</span><span style=\"color:#DCBDFB\">atMost</span><span style=\"color:#ADBAC7\">(Duration.</span><span style=\"color:#DCBDFB\">ofSeconds</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">5</span><span style=\"color:#ADBAC7\">))</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        .</span><span style=\"color:#DCBDFB\">until</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">-></span><span style=\"color:#DCBDFB\"> countLeaders</span><span style=\"color:#ADBAC7\">(nodes) </span><span style=\"color:#F47067\">==</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h2 id=\"参考資料\">参考資料</h2>\n<ul>\n<li><a href=\"https://raft.github.io/raft.pdf\">In Search of an Understandable Consensus Algorithm (Raft論文)</a></li>\n<li><a href=\"https://raft.github.io/\">The Raft Consensus Algorithm</a></li>\n<li><a href=\"http://thesecretlivesofdata.com/raft/\">Raft Visualization</a></li>\n<li><a href=\"https://dataintensive.net/\">Designing Data-Intensive Applications</a></li>\n</ul>\n<br>\n<h2 id=\"今後の改善予定\">今後の改善予定</h2>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> ログの永続化（ファイル保存）</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 簡易的なCLIクライアントの作成</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> ノードの状態をWebで可視化</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> テストカバレッジの向上</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> READMEの充実</li>\n</ul>\n<br>\n<h2 id=\"まとめ\">まとめ</h2>\n<p>分散システムは理論を読むだけでは理解が難しく、実際に実装してみることで多くの気づきがありました。</p>\n<p>特に以下の点は、実装して初めて腑に落ちました：</p>\n<ul>\n<li>リーダー選出で<strong>なぜランダムなタイムアウトが必要か</strong></li>\n<li>ログレプリケーションで<strong>なぜ過半数で良いのか</strong></li>\n<li><strong>ネットワーク分断時にどう振る舞うか</strong></li>\n</ul>\n<p>Raftは「理解しやすい」を目指したアルゴリズムですが、それでも実装には多くの edge case があり、分散システムの難しさを実感しました。</p>\n<br>\n<p>ソースコード: <a href=\"https://github.com/haroin57/distoributed-system\">haroin57/distributed-system</a></p>"
  },
  {
    "slug": "haroin57-com",
    "productSlug": "haroin57-com",
    "title": "haroin57.com - ポートフォリオサイトの技術解説",
    "summary": "React 19とViteで構築したポートフォリオサイトの実装について",
    "createdAt": "2025-12-18",
    "tags": [
      "React",
      "TypeScript",
      "Vite",
      "Cloudflare"
    ],
    "html": "<h2 id=\"目次\">目次</h2>\n<div class=\"toc-box\"><ul>\n<li><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></li>\n<li><a href=\"#%E6%8A%80%E8%A1%93%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF\">技術スタック</a></li>\n<li><a href=\"#%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89\">フロントエンド</a></li>\n<li><a href=\"#%E3%83%93%E3%83%AB%E3%83%89%E3%83%84%E3%83%BC%E3%83%AB\">ビルドツール</a></li>\n<li><a href=\"#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9\">デプロイ・インフラ</a></li>\n<li><a href=\"#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3\">アーキテクチャ</a></li>\n<li><a href=\"#%E4%B8%BB%E3%81%AA%E6%A9%9F%E8%83%BD%E3%81%A8%E5%AE%9F%E8%A3%85%E8%A9%B3%E7%B4%B0\">主な機能と実装詳細</a></li>\n<li><a href=\"#1-%E3%83%9A%E3%83%BC%E3%82%B8%E9%81%B7%E7%A7%BB%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\">1. ページ遷移アニメーション</a></li>\n<li><a href=\"#2-inpinteraction-to-next-paint%E6%9C%80%E9%81%A9%E5%8C%96\">2. INP（Interaction to Next Paint）最適化</a></li>\n<li><a href=\"#starttransition%E3%81%AB%E3%82%88%E3%82%8B%E5%84%AA%E5%85%88%E5%BA%A6%E5%88%B6%E5%BE%A1\">startTransitionによる優先度制御</a></li>\n<li><a href=\"#content-visibility%E3%81%AB%E3%82%88%E3%82%8B%E9%81%85%E5%BB%B6%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0\">content-visibilityによる遅延レンダリング</a></li>\n<li><a href=\"#reactlazy%E3%81%AB%E3%82%88%E3%82%8B%E5%8B%95%E7%9A%84%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88\">React.lazyによる動的インポート</a></li>\n<li><a href=\"#3-markdown%E3%83%96%E3%83%AD%E3%82%B0%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0\">3. Markdownブログシステム</a></li>\n<li><a href=\"#%E4%BD%BF%E7%94%A8%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3\">使用プラグイン</a></li>\n<li><a href=\"#%E3%83%93%E3%83%AB%E3%83%89%E6%99%82%E5%87%A6%E7%90%86%E3%83%95%E3%83%AD%E3%83%BC\">ビルド時処理フロー</a></li>\n<li><a href=\"#%E6%95%B0%E5%BC%8F%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E4%BE%8B\">数式レンダリング例</a></li>\n<li><a href=\"#4-%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E9%80%A3%E5%8B%95%E8%83%8C%E6%99%AF%E3%82%A8%E3%83%95%E3%82%A7%E3%82%AF%E3%83%88\">4. スクロール連動背景エフェクト</a></li>\n<li><a href=\"#5-adobe-fonts%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96\">5. Adobe Fontsの最適化</a></li>\n<li><a href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E6%9C%80%E9%81%A9%E5%8C%96\">パフォーマンス最適化</a></li>\n<li><a href=\"#cloudflare-edge-caching\">Cloudflare Edge Caching</a></li>\n<li><a href=\"#%E7%94%BB%E5%83%8F%E6%9C%80%E9%81%A9%E5%8C%96\">画像最適化</a></li>\n<li><a href=\"#%E3%83%90%E3%83%B3%E3%83%89%E3%83%AB%E3%82%B5%E3%82%A4%E3%82%BA%E5%89%8A%E6%B8%9B\">バンドルサイズ削減</a></li>\n<li><a href=\"#%E9%96%8B%E7%99%BA%E4%BD%93%E9%A8%93\">開発体験</a></li>\n<li><a href=\"#hmrhot-module-replacement\">HMR（Hot Module Replacement）</a></li>\n<li><a href=\"#%E5%9E%8B%E5%AE%89%E5%85%A8%E6%80%A7\">型安全性</a></li>\n<li><a href=\"#%E4%BB%8A%E5%BE%8C%E3%81%AE%E6%94%B9%E5%96%84%E4%BA%88%E5%AE%9A\">今後の改善予定</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul></div>\n<br>\n<h2 id=\"はじめに\">はじめに</h2>\n<p>このサイト（haroin57.com）自体がProductsの1つです。React 19とViteを使って構築し、Cloudflare Pagesにデプロイしています。</p>\n<p>パフォーマンスとユーザー体験を重視して設計しました。モダンなReactの機能をフル活用しつつ、Web Vitals（特にINP）の最適化に注力しています。</p>\n<br>\n<h2 id=\"技術スタック\">技術スタック</h2>\n<br>\n<h3 id=\"フロントエンド\">フロントエンド</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>React 19</strong></td><td>最新のReact。React Compilerによる自動最適化を有効化</td></tr><tr><td><strong>TypeScript</strong></td><td>型安全な開発。strict modeで運用</td></tr><tr><td><strong>Tailwind CSS v4</strong></td><td>ユーティリティファーストなスタイリング</td></tr><tr><td><strong>React Router v7</strong></td><td>クライアントサイドルーティング</td></tr></tbody></table></div>\n<br>\n<h3 id=\"ビルドツール\">ビルドツール</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>Vite 7</strong></td><td>高速な開発サーバーとビルド</td></tr><tr><td><strong>Rolldown</strong></td><td>ESBuildの代替。Rustベースでさらなる高速化</td></tr><tr><td><strong>React Compiler</strong></td><td>useMemo/useCallbackの自動挿入</td></tr></tbody></table></div>\n<br>\n<h3 id=\"デプロイインフラ\">デプロイ・インフラ</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>Cloudflare Pages</strong></td><td>グローバルCDNによる高速配信</td></tr><tr><td><strong>Cloudflare Workers</strong></td><td>アクセスカウンターのバックエンド</td></tr><tr><td><strong>Cloudflare KV</strong></td><td>いいね数などの永続化ストレージ</td></tr></tbody></table></div>\n<br>\n<h2 id=\"アーキテクチャ\">アーキテクチャ</h2>\n<div class=\"mermaid-block\" data-mermaid=\"flowchart TB\n    subgraph Edge[&#x22;Cloudflare Edge&#x22;]\n        Pages[&#x22;Pages<br/>(静的配信)&#x22;]\n        Workers[&#x22;Workers<br/>(API処理)&#x22;]\n        KV[&#x22;KV<br/>(データ保存)&#x22;]\n    end\n\n    subgraph Client[&#x22;React SPA (Client)&#x22;]\n        Router[&#x22;Router<br/>(React Router v7)&#x22;]\n        PageComponents[&#x22;Pages<br/>(Home, Posts, Products)&#x22;]\n        Components[&#x22;Components<br/>(UI部品)&#x22;]\n    end\n\n    Pages --> Router\n    Router --> PageComponents\n    PageComponents --> Components\n    PageComponents <--> Workers\n    Workers <--> KV\n\n    style Pages fill:#f97316,stroke:#fdba74,stroke-width:2px,color:#fff\n    style Router fill:#134e4a,stroke:#5eead4,stroke-width:2px\n    style KV fill:#3b2f4a,stroke:#a78bfa,stroke-width:2px\"></div>\n<br>\n<h2 id=\"主な機能と実装詳細\">主な機能と実装詳細</h2>\n<br>\n<h3 id=\"1-ページ遷移アニメーション\">1. ページ遷移アニメーション</h3>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>react-transition-group</span></span></code></span> の <span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>CSSTransition</span></span></code></span> を使用してページ間の遷移をスムーズにしています。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TSX</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"tsx\" data-theme=\"github-dark-dimmed\"><code data-language=\"tsx\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> { CSSTransition, TransitionGroup } </span><span style=\"color:#F47067\">from</span><span style=\"color:#96D0FF\"> 'react-transition-group'</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">&#x3C;</span><span style=\"color:#8DDB8C\">TransitionGroup</span><span style=\"color:#6CB6FF\"> component</span><span style=\"color:#F47067\">={</span><span style=\"color:#6CB6FF\">null</span><span style=\"color:#F47067\">}</span><span style=\"color:#ADBAC7\">></span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  &#x3C;</span><span style=\"color:#8DDB8C\">CSSTransition</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">    key</span><span style=\"color:#F47067\">={</span><span style=\"color:#ADBAC7\">location.pathname</span><span style=\"color:#F47067\">}</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">    classNames</span><span style=\"color:#F47067\">=</span><span style=\"color:#96D0FF\">\"page-transition\"</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">    timeout</span><span style=\"color:#F47067\">={</span><span style=\"color:#6CB6FF\">300</span><span style=\"color:#F47067\">}</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  ></span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    &#x3C;</span><span style=\"color:#8DDB8C\">Routes</span><span style=\"color:#6CB6FF\"> location</span><span style=\"color:#F47067\">={</span><span style=\"color:#ADBAC7\">location</span><span style=\"color:#F47067\">}</span><span style=\"color:#ADBAC7\">></span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">      {</span><span style=\"color:#768390\">/* ルート定義 */</span><span style=\"color:#F47067\">}</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    &#x3C;/</span><span style=\"color:#8DDB8C\">Routes</span><span style=\"color:#ADBAC7\">></span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  &#x3C;/</span><span style=\"color:#8DDB8C\">CSSTransition</span><span style=\"color:#ADBAC7\">></span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">&#x3C;/</span><span style=\"color:#8DDB8C\">TransitionGroup</span><span style=\"color:#ADBAC7\">></span></span></code></pre></figure>\n<p>CSSでは以下のようにアニメーションを定義：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">CSS</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"css\" data-theme=\"github-dark-dimmed\"><code data-language=\"css\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#6CB6FF\">.page-transition-enter</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  opacity</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  transform</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">translateY</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">10</span><span style=\"color:#F47067\">px</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">.page-transition-enter-active</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  opacity</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  transform</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">translateY</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  transition</span><span style=\"color:#ADBAC7\">: opacity </span><span style=\"color:#6CB6FF\">300</span><span style=\"color:#F47067\">ms</span><span style=\"color:#ADBAC7\">, transform </span><span style=\"color:#6CB6FF\">300</span><span style=\"color:#F47067\">ms</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">.page-transition-exit</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  opacity</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">.page-transition-exit-active</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  opacity</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  transition</span><span style=\"color:#ADBAC7\">: opacity </span><span style=\"color:#6CB6FF\">200</span><span style=\"color:#F47067\">ms</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h3 id=\"2-inpinteraction-to-next-paint最適化\">2. INP（Interaction to Next Paint）最適化</h3>\n<p>ユーザーインタラクションの応答性を向上させるため、複数の最適化を実施しています。</p>\n<br>\n<h4 id=\"starttransitionによる優先度制御\">startTransitionによる優先度制御</h4>\n<p>状態更新の優先度を制御し、UIのブロッキングを防止：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TSX</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"tsx\" data-theme=\"github-dark-dimmed\"><code data-language=\"tsx\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> { startTransition } </span><span style=\"color:#F47067\">from</span><span style=\"color:#96D0FF\"> 'react'</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">const</span><span style=\"color:#DCBDFB\"> handleTagSelect</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> (</span><span style=\"color:#F69D50\">tag</span><span style=\"color:#F47067\">:</span><span style=\"color:#6CB6FF\"> string</span><span style=\"color:#ADBAC7\">) </span><span style=\"color:#F47067\">=></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">  startTransition</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">=></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#768390\">    // 低優先度の状態更新</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    setSearchParams</span><span style=\"color:#ADBAC7\">(nextParams)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  })</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h4 id=\"content-visibilityによる遅延レンダリング\">content-visibilityによる遅延レンダリング</h4>\n<p>オフスクリーンのコンテンツをレンダリングスキップ：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">CSS</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"css\" data-theme=\"github-dark-dimmed\"><code data-language=\"css\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#6CB6FF\">.post-content</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  content-visibility</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">auto</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">  contain-intrinsic-size</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#6CB6FF\"> 500</span><span style=\"color:#F47067\">px</span><span style=\"color:#ADBAC7\">;</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span></code></pre></figure>\n<br>\n<h4 id=\"reactlazyによる動的インポート\">React.lazyによる動的インポート</h4>\n<p>重いコンポーネントを必要時にのみ読み込み：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TSX</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"tsx\" data-theme=\"github-dark-dimmed\"><code data-language=\"tsx\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">const</span><span style=\"color:#6CB6FF\"> PostDetail</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> lazy</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">=></span><span style=\"color:#F47067\"> import</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">'./routes/PostDetail'</span><span style=\"color:#ADBAC7\">))</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">const</span><span style=\"color:#6CB6FF\"> ProductDetail</span><span style=\"color:#F47067\"> =</span><span style=\"color:#DCBDFB\"> lazy</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">=></span><span style=\"color:#F47067\"> import</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">'./routes/ProductDetail'</span><span style=\"color:#ADBAC7\">))</span></span></code></pre></figure>\n<br>\n<h3 id=\"3-markdownブログシステム\">3. Markdownブログシステム</h3>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>remark</span></span></code></span> / <span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>rehype</span></span></code></span> エコシステムを使用してMarkdownをHTMLに変換しています。</p>\n<br>\n<h4 id=\"使用プラグイン\">使用プラグイン</h4>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>プラグイン</th><th>用途</th></tr></thead><tbody><tr><td><strong>remark-gfm</strong></td><td>GitHub Flavored Markdown（テーブル、タスクリストなど）</td></tr><tr><td><strong>remark-math</strong></td><td>数式記法のパース</td></tr><tr><td><strong>rehype-katex</strong></td><td>KaTeXによる数式レンダリング</td></tr><tr><td><strong>rehype-pretty-code</strong></td><td>shikiによるシンタックスハイライト</td></tr><tr><td><strong>remark-toc</strong></td><td>目次の自動生成</td></tr></tbody></table></div>\n<br>\n<h4 id=\"ビルド時処理フロー\">ビルド時処理フロー</h4>\n<div class=\"mermaid-block\" data-mermaid=\"flowchart LR\n    MD[&#x22;.md files<br/>(content/)&#x22;] --> Matter[&#x22;gray-matter<br/>(frontmatter)&#x22;]\n    Matter --> Remark[&#x22;remark<br/>(parse MD)&#x22;]\n    Remark --> Rehype[&#x22;rehype<br/>(HTML変換)&#x22;]\n    Rehype --> JSON[&#x22;posts.json<br/>(出力)&#x22;]\n\n    style MD fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px\n    style JSON fill:#134e4a,stroke:#5eead4,stroke-width:2px\"></div>\n<br>\n<h4 id=\"数式レンダリング例\">数式レンダリング例</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">MD</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"markdown\" data-theme=\"github-dark-dimmed\"><code data-language=\"markdown\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#ADBAC7\">$$</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">E = mc^2</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">$$</span></span></code></pre></figure>\n<p>のような記法で数式が書けます。実際の表示例:</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>E</mi><mo>=</mo><mi>m</mi><msup><mi>c</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">E = mc^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8641em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8641em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span>\n<p>インライン数式も対応しています：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>a</mi><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mi>b</mi><mi>x</mi><mo>+</mo><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">f(x) = ax^2 + bx + c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8974em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span></p>\n<br>\n<h3 id=\"4-スクロール連動背景エフェクト\">4. スクロール連動背景エフェクト</h3>\n<p>投稿詳細ページでは、スクロールに応じて背景にブラーエフェクトを適用しています。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TSX</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"tsx\" data-theme=\"github-dark-dimmed\"><code data-language=\"tsx\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#DCBDFB\">useEffect</span><span style=\"color:#ADBAC7\">(() </span><span style=\"color:#F47067\">=></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">  const</span><span style=\"color:#6CB6FF\"> startPx</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 48</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">  const</span><span style=\"color:#6CB6FF\"> rangePx</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 420</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">  const</span><span style=\"color:#6CB6FF\"> maxBlurPx</span><span style=\"color:#F47067\"> =</span><span style=\"color:#6CB6FF\"> 5</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">  const</span><span style=\"color:#DCBDFB\"> update</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> () </span><span style=\"color:#F47067\">=></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    const</span><span style=\"color:#6CB6FF\"> y</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> window.scrollY </span><span style=\"color:#F47067\">||</span><span style=\"color:#6CB6FF\"> 0</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    const</span><span style=\"color:#6CB6FF\"> t</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> Math.</span><span style=\"color:#DCBDFB\">max</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">, Math.</span><span style=\"color:#DCBDFB\">min</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">, (y </span><span style=\"color:#F47067\">-</span><span style=\"color:#ADBAC7\"> startPx) </span><span style=\"color:#F47067\">/</span><span style=\"color:#ADBAC7\"> rangePx))</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    const</span><span style=\"color:#6CB6FF\"> blur</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> t </span><span style=\"color:#F47067\">*</span><span style=\"color:#ADBAC7\"> maxBlurPx</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    document.body.style.</span><span style=\"color:#DCBDFB\">setProperty</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">'--bg-blur'</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">`${</span><span style=\"color:#ADBAC7\">blur</span><span style=\"color:#96D0FF\">}px`</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">  const</span><span style=\"color:#DCBDFB\"> onScroll</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> () </span><span style=\"color:#F47067\">=></span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">    requestAnimationFrame</span><span style=\"color:#ADBAC7\">(update)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">  window.</span><span style=\"color:#DCBDFB\">addEventListener</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">'scroll'</span><span style=\"color:#ADBAC7\">, onScroll, { passive: </span><span style=\"color:#6CB6FF\">true</span><span style=\"color:#ADBAC7\"> })</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">  return</span><span style=\"color:#ADBAC7\"> () </span><span style=\"color:#F47067\">=></span><span style=\"color:#ADBAC7\"> window.</span><span style=\"color:#DCBDFB\">removeEventListener</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">'scroll'</span><span style=\"color:#ADBAC7\">, onScroll)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}, [])</span></span></code></pre></figure>\n<br>\n<h3 id=\"5-adobe-fontsの最適化\">5. Adobe Fontsの最適化</h3>\n<p>Adobe Fontsを使用していますが、ロード時間を最小化するために以下を実施：</p>\n<ul>\n<li><strong>dns-prefetch / preconnect</strong> でDNS解決を事前に実行</li>\n<li>フォント読み込み前はシステムフォントにフォールバック</li>\n<li><strong>font-display: swap</strong> で表示のブロッキングを回避</li>\n</ul>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">HTML</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"html\" data-theme=\"github-dark-dimmed\"><code data-language=\"html\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#ADBAC7\">&#x3C;</span><span style=\"color:#8DDB8C\">link</span><span style=\"color:#6CB6FF\"> rel</span><span style=\"color:#ADBAC7\">=</span><span style=\"color:#96D0FF\">\"preconnect\"</span><span style=\"color:#6CB6FF\"> href</span><span style=\"color:#ADBAC7\">=</span><span style=\"color:#96D0FF\">\"https://use.typekit.net\"</span><span style=\"color:#6CB6FF\"> crossorigin</span><span style=\"color:#ADBAC7\"> /></span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">&#x3C;</span><span style=\"color:#8DDB8C\">link</span><span style=\"color:#6CB6FF\"> rel</span><span style=\"color:#ADBAC7\">=</span><span style=\"color:#96D0FF\">\"dns-prefetch\"</span><span style=\"color:#6CB6FF\"> href</span><span style=\"color:#ADBAC7\">=</span><span style=\"color:#96D0FF\">\"https://use.typekit.net\"</span><span style=\"color:#ADBAC7\"> /></span></span></code></pre></figure>\n<br>\n<h2 id=\"パフォーマンス最適化\">パフォーマンス最適化</h2>\n<br>\n<h3 id=\"cloudflare-edge-caching\">Cloudflare Edge Caching</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>リソース</th><th>キャッシュ戦略</th></tr></thead><tbody><tr><td>静的アセット（JS/CSS/画像）</td><td>長期キャッシュ（1年）+ immutable</td></tr><tr><td>HTML</td><td>短いTTL（5分）で鮮度維持</td></tr><tr><td>API レスポンス</td><td>KVによる永続化</td></tr></tbody></table></div>\n<br>\n<h3 id=\"画像最適化\">画像最適化</h3>\n<ul>\n<li><strong>WebP形式</strong>を採用（JPEG比30-40%軽量化）</li>\n<li><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>loading=\"lazy\"</span></span></code></span> で遅延読み込み</li>\n<li>適切なサイズの画像を提供（srcset未使用だが検討中）</li>\n</ul>\n<br>\n<h3 id=\"バンドルサイズ削減\">バンドルサイズ削減</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>手法</th><th>効果</th></tr></thead><tbody><tr><td>Tree Shaking</td><td>未使用コードの除去</td></tr><tr><td>Code Splitting</td><td>ルートベースの分割</td></tr><tr><td>Dynamic Import</td><td>必要時のみロード</td></tr></tbody></table></div>\n<br>\n<h2 id=\"開発体験\">開発体験</h2>\n<br>\n<h3 id=\"hmrhot-module-replacement\">HMR（Hot Module Replacement）</h3>\n<p>Vite + Rolldownにより、ファイル変更から画面反映まで<strong>50ms以下</strong>を実現。</p>\n<br>\n<h3 id=\"型安全性\">型安全性</h3>\n<p>TypeScript strict modeに加え、以下で型安全性を強化：</p>\n<ul>\n<li>eslint-plugin-react-compiler による React Compiler互換性チェック</li>\n<li>明示的な型アノテーション必須化</li>\n</ul>\n<br>\n<h2 id=\"今後の改善予定\">今後の改善予定</h2>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 記事の検索機能追加</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> ダークモード/ライトモードの切り替えボタン</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 記事の目次をサイドバーに表示</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> コードブロックのファイル名表示</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 関連記事の表示</li>\n</ul>\n<br>\n<h2 id=\"まとめ\">まとめ</h2>\n<p>モダンなReactの機能を活用しつつ、パフォーマンスにも気を配ったサイトを構築できました。</p>\n<p>特にReact 19 + React Compilerの組み合わせは、手動でのメモ化を不要にし、開発体験を大幅に向上させてくれます。Vite + Rolldownによるビルドも高速で、開発イテレーションが非常にスムーズです。</p>\n<br>\n<p>ソースコードはGitHubで公開しています: <a href=\"https://github.com/haroin57/haroin57.com\">haroin57/haroin57.com</a></p>"
  },
  {
    "slug": "timetable-bot",
    "productSlug": "timetable-bot",
    "title": "timetable-bot - LINE時間割管理Botの解説",
    "summary": "PythonとLINE Messaging API、GPTを使った時間割管理Botについて",
    "createdAt": "2025-12-18",
    "tags": [
      "Python",
      "LINE",
      "Bot",
      "GPT",
      "OpenAI"
    ],
    "html": "<h2 id=\"目次\">目次</h2>\n<div class=\"toc-box\"><ul>\n<li><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\">はじめに</a></li>\n<li><a href=\"#%E6%8A%80%E8%A1%93%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF\">技術スタック</a></li>\n<li><a href=\"#%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E8%A8%80%E8%AA%9E\">ランタイム・言語</a></li>\n<li><a href=\"#%E5%A4%96%E9%83%A8%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9api\">外部サービス・API</a></li>\n<li><a href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9\">データベース</a></li>\n<li><a href=\"#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3\">システムアーキテクチャ</a></li>\n<li><a href=\"#%E4%B8%BB%E3%81%AA%E6%A9%9F%E8%83%BD\">主な機能</a></li>\n<li><a href=\"#1-%E6%99%82%E9%96%93%E5%89%B2%E3%81%AE%E7%99%BB%E9%8C%B2\">1. 時間割の登録</a></li>\n<li><a href=\"#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%A7%E7%99%BB%E9%8C%B2\">テキストで登録</a></li>\n<li><a href=\"#%E7%94%BB%E5%83%8F%E3%81%A7%E7%99%BB%E9%8C%B2\">画像で登録</a></li>\n<li><a href=\"#2-%E6%99%82%E9%96%93%E5%89%B2%E3%81%AE%E7%B7%A8%E9%9B%86%E5%89%8A%E9%99%A4\">2. 時間割の編集・削除</a></li>\n<li><a href=\"#%E8%BF%BD%E5%8A%A0\">追加</a></li>\n<li><a href=\"#%E5%89%8A%E9%99%A4\">削除</a></li>\n<li><a href=\"#%E7%BD%AE%E6%8F%9B%E4%BF%AE%E6%AD%A3%E5%A4%89%E6%9B%B4\">置換（修正・変更）</a></li>\n<li><a href=\"#%E6%95%99%E5%AE%A4%E3%81%AE%E5%A4%89%E6%9B%B4\">教室の変更</a></li>\n<li><a href=\"#%E6%99%82%E5%88%BB%E3%81%AE%E5%A4%89%E6%9B%B4\">時刻の変更</a></li>\n<li><a href=\"#%E5%85%A8%E5%89%8A%E9%99%A4\">全削除</a></li>\n<li><a href=\"#3-%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E8%A1%A8%E7%A4%BA\">3. スケジュール表示</a></li>\n<li><a href=\"#%E4%B8%80%E8%A6%A7%E8%A1%A8%E7%A4%BA\">一覧表示</a></li>\n<li><a href=\"#4-%E3%83%AA%E3%83%9E%E3%82%A4%E3%83%B3%E3%83%80%E3%83%BC%E9%80%9A%E7%9F%A5\">4. リマインダー通知</a></li>\n<li><a href=\"#5-%E3%83%98%E3%83%AB%E3%83%97\">5. ヘルプ</a></li>\n<li><a href=\"#%E5%AE%9F%E8%A3%85%E8%A9%B3%E7%B4%B0\">実装詳細</a></li>\n<li><a href=\"#webhook%E5%87%A6%E7%90%86\">Webhook処理</a></li>\n<li><a href=\"#gpt%E3%81%AB%E3%82%88%E3%82%8B%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E8%A7%A3%E6%9E%90\">GPTによるメッセージ解析</a></li>\n<li><a href=\"#%E7%94%BB%E5%83%8F%E3%81%8B%E3%82%89%E3%81%AE%E6%99%82%E9%96%93%E5%89%B2%E6%8A%BD%E5%87%BA\">画像からの時間割抽出</a></li>\n<li><a href=\"#%E6%99%82%E9%99%90%E3%81%8B%E3%82%89%E6%99%82%E5%88%BB%E3%81%B8%E3%81%AE%E3%83%9E%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0\">時限から時刻へのマッピング</a></li>\n<li><a href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E8%A8%AD%E8%A8%88\">データベース設計</a></li>\n<li><a href=\"#%E3%83%AA%E3%83%9E%E3%82%A4%E3%83%B3%E3%83%80%E3%83%BC%E3%81%AE%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0\">リマインダーのスケジューリング</a></li>\n<li><a href=\"#%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%BE%E3%83%BC%E3%83%B3%E5%AF%BE%E5%BF%9C\">タイムゾーン対応</a></li>\n<li><a href=\"#%E8%8B%A6%E5%8A%B4%E3%81%97%E3%81%9F%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\">苦労したポイント</a></li>\n<li><a href=\"#1-gpt%E3%81%AB%E3%82%88%E3%82%8B%E6%9F%94%E8%BB%9F%E3%81%AA%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E8%A7%A3%E6%9E%90\">1. GPTによる柔軟なメッセージ解析</a></li>\n<li><a href=\"#2-%E3%83%AA%E3%83%9E%E3%82%A4%E3%83%B3%E3%83%80%E3%83%BC%E3%81%AE%E6%AD%A3%E7%A2%BA%E6%80%A7\">2. リマインダーの正確性</a></li>\n<li><a href=\"#3-%E8%A4%87%E6%95%B0%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%AF%BE%E5%BF%9C\">3. 複数ユーザー対応</a></li>\n<li><a href=\"#%E4%BB%8A%E5%BE%8C%E3%81%AE%E6%94%B9%E5%96%84%E4%BA%88%E5%AE%9A\">今後の改善予定</a></li>\n<li><a href=\"#%E9%96%8B%E7%99%BA%E3%81%A7%E5%AD%A6%E3%82%93%E3%81%A0%E3%81%93%E3%81%A8\">開発で学んだこと</a></li>\n<li><a href=\"#line-bot%E9%96%8B%E7%99%BA%E3%81%AE%E5%9F%BA%E7%A4%8E\">LINE Bot開発の基礎</a></li>\n<li><a href=\"#gpt-api%E3%81%AE%E6%B4%BB%E7%94%A8\">GPT APIの活用</a></li>\n<li><a href=\"#python%E3%81%A7%E3%81%AE%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86\">Pythonでの非同期処理</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul></div>\n<br>\n<h2 id=\"はじめに\">はじめに</h2>\n<p>大学の時間割を管理するために作ったLINE Botです。LINEで話しかけるだけで時間割の確認やリマインダー設定ができます。</p>\n<p><strong>GPTを使ってユーザーのメッセージを解析</strong>し、自然な日本語から構造化データ（JSON）を抽出しています。これにより、厳密なコマンド形式を覚えなくても直感的に操作できます。</p>\n<p>毎日の授業管理をもっと楽にしたいという動機から開発しました。「今日の授業なんだっけ？」をLINEで即座に確認できるのが便利です。</p>\n<br>\n<h2 id=\"技術スタック\">技術スタック</h2>\n<br>\n<h3 id=\"ランタイム言語\">ランタイム・言語</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>Python 3.11+</strong></td><td>メイン言語。型ヒント活用</td></tr><tr><td><strong>FastAPI</strong></td><td>非同期対応Webフレームワーク</td></tr></tbody></table></div>\n<br>\n<h3 id=\"外部サービスapi\">外部サービス・API</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>LINE Messaging API</strong></td><td>LINEとの連携</td></tr><tr><td><strong>LINE Messaging API SDK</strong></td><td>Python SDK</td></tr><tr><td><strong>OpenAI API (GPT)</strong></td><td>メッセージ解析・JSON抽出</td></tr></tbody></table></div>\n<br>\n<h3 id=\"データベース\">データベース</h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<div class=\"table-wrapper\"><table><thead><tr><th>技術</th><th>説明</th></tr></thead><tbody><tr><td><strong>SQLite</strong></td><td>軽量で扱いやすいDB</td></tr><tr><td><strong>APScheduler</strong></td><td>リマインダーのスケジューリング</td></tr></tbody></table></div>\n<br>\n<h2 id=\"システムアーキテクチャ\">システムアーキテクチャ</h2>\n<div class=\"mermaid-block\" data-mermaid=\"flowchart TB\n    subgraph LINE[&#x22;LINE Platform&#x22;]\n        User[&#x22;LINE App<br/>(User)&#x22;]\n        API[&#x22;Messaging API&#x22;]\n    end\n\n    subgraph Server[&#x22;FastAPI Server&#x22;]\n        Webhook[&#x22;Webhook Handler&#x22;]\n        GPT[&#x22;OpenAI GPT<br/>(メッセージ解析)&#x22;]\n        Response[&#x22;Response Builder&#x22;]\n    end\n\n    subgraph Data[&#x22;Data Layer&#x22;]\n        Scheduler[&#x22;APScheduler<br/>(リマインダー)&#x22;]\n        DB[&#x22;SQLite<br/>(Database)&#x22;]\n    end\n\n    User <-->|メッセージ/画像| API\n    API -->|Webhook| Webhook\n    Webhook --> GPT\n    GPT -->|JSON抽出| Response\n    Response -->|返信| API\n    Scheduler -->|Push通知| API\n    GPT <--> DB\n    Scheduler <--> DB\n\n    style GPT fill:#134e4a,stroke:#5eead4,stroke-width:2px\n    style User fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px\n    style DB fill:#3b2f4a,stroke:#a78bfa,stroke-width:2px\"></div>\n<br>\n<h2 id=\"主な機能\">主な機能</h2>\n<br>\n<h3 id=\"1-時間割の登録\">1. 時間割の登録</h3>\n<p>テキストまたは画像で時間割を登録できます。GPTが自然言語を解析するため、厳密なコマンド形式を覚える必要はありません。</p>\n<br>\n<h4 id=\"テキストで登録\">テキストで登録</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>月曜1限 解析学 C3 101</span></span>\n<span data-line=\"\"><span>火曜2限 英語 A棟201</span></span></code></pre></figure>\n<p>のように送信すると、GPTが内容を解析して確認メッセージを返します：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>この内容で実行しますか？はい / いいえ</span></span></code></pre></figure>\n<p>「はい」と答えると登録が完了し、結果が表示されます：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>授業を追加しました。内訳は以下です。</span></span>\n<span data-line=\"\"><span>誤りがあれば「追加」「削除」「置換」で修正できます。</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span>- 月 09:00-10:30 解析学 / 教室: C3 101</span></span>\n<span data-line=\"\"><span>- 火 10:40-12:10 英語 / 教室: A棟201</span></span></code></pre></figure>\n<br>\n<h4 id=\"画像で登録\">画像で登録</h4>\n<p>時間割の画像（スクリーンショットなど）を送信すると、GPT-4o Visionが内容を読み取って登録できます。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>画像から時間割を登録しました。内訳は以下です。</span></span></code></pre></figure>\n<br>\n<h3 id=\"2-時間割の編集削除\">2. 時間割の編集・削除</h3>\n<br>\n<h4 id=\"追加\">追加</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>追加 水曜3限 プログラミング PC室1</span></span></code></pre></figure>\n<br>\n<h4 id=\"削除\">削除</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>削除 月曜1限</span></span></code></pre></figure>\n<br>\n<h4 id=\"置換修正変更\">置換（修正・変更）</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>置換 月曜1限 微分積分 B棟301</span></span></code></pre></figure>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>修正</span></span></code></span> や <span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>変更</span></span></code></span> でも同様に動作します。</p>\n<br>\n<h4 id=\"教室の変更\">教室の変更</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>教室 月曜1限 C棟102</span></span></code></pre></figure>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>場所</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>location</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>room</span></span></code></span> でも同様に動作します。</p>\n<br>\n<h4 id=\"時刻の変更\">時刻の変更</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>時間 月曜1限 09:30 11:00</span></span></code></pre></figure>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>時間変更</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>time</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>時刻</span></span></code></span> でも同様に動作します。</p>\n<br>\n<h4 id=\"全削除\">全削除</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>リセット</span></span></code></pre></figure>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>reset</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>クリア</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>clear</span></span></code></span> で全時間割を削除できます。</p>\n<br>\n<h3 id=\"3-スケジュール表示\">3. スケジュール表示</h3>\n<br>\n<h4 id=\"一覧表示\">一覧表示</h4>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>一覧</span></span></code></pre></figure>\n<p>と送信すると、登録済みの時間割を表示します：</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>- 月 09:00-10:30 解析学 / 教室: C3 101</span></span>\n<span data-line=\"\"><span>- 火 10:40-12:10 英語 / 教室: 未設定</span></span>\n<span data-line=\"\"><span>- 水 13:00-14:30 プログラミング / 教室: PC室1</span></span></code></pre></figure>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>確認</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>時間割</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>schedule</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>list</span></span></code></span> でも同様に表示されます。</p>\n<br>\n<h3 id=\"4-リマインダー通知\">4. リマインダー通知</h3>\n<p>授業開始<strong>10分前</strong>に自動でプッシュ通知を送信します（デフォルト設定）。</p>\n<p>時間割を登録すると、APSchedulerが各曜日・時刻にジョブを登録し、該当時刻に通知を送信します。</p>\n<br>\n<h3 id=\"5-ヘルプ\">5. ヘルプ</h3>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">TEXT</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span>ヘルプ</span></span></code></pre></figure>\n<p>と送信すると、使い方の一覧を表示します。<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>help</span></span></code></span>、<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>使い方</span></span></code></span> でも同様です。</p>\n<br>\n<h2 id=\"実装詳細\">実装詳細</h2>\n<br>\n<h3 id=\"webhook処理\">Webhook処理</h3>\n<p>LINE Messaging APIからのWebhookを受け取り、HMAC SHA256で署名検証後、非同期でメッセージを処理します。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Python</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"python\" data-theme=\"github-dark-dimmed\"><code data-language=\"python\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">from</span><span style=\"color:#ADBAC7\"> fastapi </span><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> FastAPI, Request, BackgroundTasks</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> hmac</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> hashlib</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">app </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> FastAPI()</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#DCBDFB\">@app.post</span><span style=\"color:#ADBAC7\">(</span><span style=\"color:#96D0FF\">\"/callback\"</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">async</span><span style=\"color:#F47067\"> def</span><span style=\"color:#DCBDFB\"> callback</span><span style=\"color:#ADBAC7\">(request: Request, background_tasks: BackgroundTasks):</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    body </span><span style=\"color:#F47067\">=</span><span style=\"color:#F47067\"> await</span><span style=\"color:#ADBAC7\"> request.body()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    signature </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> request.headers.get(</span><span style=\"color:#96D0FF\">\"x-line-signature\"</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    # HMAC SHA256 署名検証</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    hash_value </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> hmac.new(</span></span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">        LINE_CHANNEL_SECRET</span><span style=\"color:#ADBAC7\">.encode(),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        body,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        hashlib.sha256</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    ).digest()</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    if</span><span style=\"color:#F47067\"> not</span><span style=\"color:#ADBAC7\"> hmac.compare_digest(signature, base64.b64encode(hash_value).decode()):</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">        raise</span><span style=\"color:#ADBAC7\"> HTTPException(</span><span style=\"color:#F69D50\">status_code</span><span style=\"color:#F47067\">=</span><span style=\"color:#6CB6FF\">400</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    # 非同期でイベント処理</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    events </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> json.loads(body)[</span><span style=\"color:#96D0FF\">\"events\"</span><span style=\"color:#ADBAC7\">]</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    for</span><span style=\"color:#ADBAC7\"> event </span><span style=\"color:#F47067\">in</span><span style=\"color:#ADBAC7\"> events:</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        background_tasks.add_task(handle_event, event)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#96D0FF\"> \"OK\"</span></span></code></pre></figure>\n<br>\n<h3 id=\"gptによるメッセージ解析\">GPTによるメッセージ解析</h3>\n<p>正規表現の代わりに<strong>OpenAI GPTを使用</strong>して、自然言語のメッセージから構造化されたJSONを抽出しています。これにより、ユーザーは厳密なコマンド形式を覚える必要がありません。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Python</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"python\" data-theme=\"github-dark-dimmed\"><code data-language=\"python\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">from</span><span style=\"color:#ADBAC7\"> openai </span><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> OpenAI</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">def</span><span style=\"color:#DCBDFB\"> call_chatgpt_to_extract_schedule</span><span style=\"color:#ADBAC7\">(timetable_text: </span><span style=\"color:#6CB6FF\">str</span><span style=\"color:#ADBAC7\">, model: </span><span style=\"color:#6CB6FF\">str</span><span style=\"color:#F47067\"> =</span><span style=\"color:#96D0FF\"> \"gpt-4o-mini\"</span><span style=\"color:#ADBAC7\">):</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"\"\"GPTを使って時間割情報をJSON形式で抽出\"\"\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    system_prompt </span><span style=\"color:#F47067\">=</span><span style=\"color:#96D0FF\"> \"\"\"You are a strict JSON extractor for university timetables.</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    Extract schedule information and return ONLY valid JSON in this format:</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    {</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">        \"action\": \"add\" | \"delete\" | \"replace\" | \"show\",</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">        \"entries\": [</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                \"day\": \"月\" | \"火\" | \"水\" | \"木\" | \"金\",</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                \"period\": 1-5,</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                \"subject\": \"科目名\",</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                \"room\": \"教室名\"</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">        ]</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    }</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"\"\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    client </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> OpenAI()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    response </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> client.chat.completions.create(</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">        model</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">model,</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">        messages</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">[</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            {</span><span style=\"color:#96D0FF\">\"role\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"system\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"content\"</span><span style=\"color:#ADBAC7\">: system_prompt},</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            {</span><span style=\"color:#96D0FF\">\"role\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"user\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"content\"</span><span style=\"color:#ADBAC7\">: timetable_text}</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        ],</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">        response_format</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">{</span><span style=\"color:#96D0FF\">\"type\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"json_object\"</span><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    )</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#ADBAC7\"> json.loads(response.choices[</span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">].message.content)</span></span></code></pre></figure>\n<br>\n<h3 id=\"画像からの時間割抽出\">画像からの時間割抽出</h3>\n<p>GPT-4oのビジョン機能を使って、<strong>時間割の画像からも情報を抽出</strong>できます。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Python</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"python\" data-theme=\"github-dark-dimmed\"><code data-language=\"python\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> base64</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">def</span><span style=\"color:#DCBDFB\"> call_chatgpt_to_extract_schedule_from_image</span><span style=\"color:#ADBAC7\">(image_data: </span><span style=\"color:#6CB6FF\">bytes</span><span style=\"color:#ADBAC7\">):</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"\"\"画像から時間割情報を抽出\"\"\"</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    base64_image </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> base64.b64encode(image_data).decode()</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    client </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> OpenAI()</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    response </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> client.chat.completions.create(</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">        model</span><span style=\"color:#F47067\">=</span><span style=\"color:#96D0FF\">\"gpt-4o\"</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">        messages</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">[</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            {</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                \"role\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"user\"</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                \"content\"</span><span style=\"color:#ADBAC7\">: [</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    {</span><span style=\"color:#96D0FF\">\"type\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"text\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"text\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"この時間割画像から授業情報をJSON形式で抽出してください\"</span><span style=\"color:#ADBAC7\">},</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    {</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                        \"type\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"image_url\"</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">                        \"image_url\"</span><span style=\"color:#ADBAC7\">: {</span><span style=\"color:#96D0FF\">\"url\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#F47067\">f</span><span style=\"color:#96D0FF\">\"data:image/jpeg;base64,</span><span style=\"color:#F47067\">{</span><span style=\"color:#ADBAC7\">base64_image</span><span style=\"color:#F47067\">}</span><span style=\"color:#96D0FF\">\"</span><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                    }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">                ]</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            }</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        ]</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    )</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#ADBAC7\"> json.loads(response.choices[</span><span style=\"color:#6CB6FF\">0</span><span style=\"color:#ADBAC7\">].message.content)</span></span></code></pre></figure>\n<br>\n<h3 id=\"時限から時刻へのマッピング\">時限から時刻へのマッピング</h3>\n<p>「1限」などの表現を具体的な開始・終了時刻に変換します。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Python</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"python\" data-theme=\"github-dark-dimmed\"><code data-language=\"python\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#6CB6FF\">DEFAULT_PERIOD_MAP</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> {</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"1\"</span><span style=\"color:#ADBAC7\">: {</span><span style=\"color:#96D0FF\">\"start\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"09:00\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"end\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"10:30\"</span><span style=\"color:#ADBAC7\">},</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"2\"</span><span style=\"color:#ADBAC7\">: {</span><span style=\"color:#96D0FF\">\"start\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"10:40\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"end\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"12:10\"</span><span style=\"color:#ADBAC7\">},</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"3\"</span><span style=\"color:#ADBAC7\">: {</span><span style=\"color:#96D0FF\">\"start\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"13:00\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"end\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"14:30\"</span><span style=\"color:#ADBAC7\">},</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"4\"</span><span style=\"color:#ADBAC7\">: {</span><span style=\"color:#96D0FF\">\"start\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"14:40\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"end\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"16:10\"</span><span style=\"color:#ADBAC7\">},</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"5\"</span><span style=\"color:#ADBAC7\">: {</span><span style=\"color:#96D0FF\">\"start\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"16:20\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"end\"</span><span style=\"color:#ADBAC7\">: </span><span style=\"color:#96D0FF\">\"17:50\"</span><span style=\"color:#ADBAC7\">},</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">}</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">def</span><span style=\"color:#DCBDFB\"> get_period_time</span><span style=\"color:#ADBAC7\">(period: </span><span style=\"color:#6CB6FF\">int</span><span style=\"color:#ADBAC7\">) -> </span><span style=\"color:#6CB6FF\">dict</span><span style=\"color:#ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#6CB6FF\"> DEFAULT_PERIOD_MAP</span><span style=\"color:#ADBAC7\">.get(</span><span style=\"color:#6CB6FF\">str</span><span style=\"color:#ADBAC7\">(period), {})</span></span></code></pre></figure>\n<br>\n<h3 id=\"データベース設計\">データベース設計</h3>\n<p>シンプルなテーブル構成で、ユーザーごとの時間割を管理しています。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">SQL</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"sql\" data-theme=\"github-dark-dimmed\"><code data-language=\"sql\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#768390\">-- 時間割テーブル</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">CREATE</span><span style=\"color:#F47067\"> TABLE</span><span style=\"color:#DCBDFB\"> timetable</span><span style=\"color:#ADBAC7\"> (</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    id </span><span style=\"color:#F47067\">INTEGER</span><span style=\"color:#F47067\"> PRIMARY KEY</span><span style=\"color:#ADBAC7\"> AUTOINCREMENT,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    user_id </span><span style=\"color:#F47067\">TEXT</span><span style=\"color:#F47067\"> NOT NULL</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    day_of_week </span><span style=\"color:#F47067\">INTEGER</span><span style=\"color:#F47067\"> NOT NULL</span><span style=\"color:#ADBAC7\">,  </span><span style=\"color:#768390\">-- 0=月, 1=火, ..., 6=日</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    period</span><span style=\"color:#F47067\"> INTEGER</span><span style=\"color:#F47067\"> NOT NULL</span><span style=\"color:#ADBAC7\">,        </span><span style=\"color:#768390\">-- 1限, 2限, ...</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    subject</span><span style=\"color:#F47067\"> TEXT</span><span style=\"color:#F47067\"> NOT NULL</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    room </span><span style=\"color:#F47067\">TEXT</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    created_at </span><span style=\"color:#F47067\">TIMESTAMP</span><span style=\"color:#F47067\"> DEFAULT</span><span style=\"color:#ADBAC7\"> CURRENT_TIMESTAMP,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    updated_at </span><span style=\"color:#F47067\">TIMESTAMP</span><span style=\"color:#F47067\"> DEFAULT</span><span style=\"color:#ADBAC7\"> CURRENT_TIMESTAMP,</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    UNIQUE</span><span style=\"color:#ADBAC7\">(user_id, day_of_week, </span><span style=\"color:#F47067\">period</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">-- リマインダー設定テーブル</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">CREATE</span><span style=\"color:#F47067\"> TABLE</span><span style=\"color:#DCBDFB\"> reminder_settings</span><span style=\"color:#ADBAC7\"> (</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    user_id </span><span style=\"color:#F47067\">TEXT</span><span style=\"color:#F47067\"> PRIMARY KEY</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    enabled</span><span style=\"color:#F47067\"> INTEGER</span><span style=\"color:#F47067\"> DEFAULT</span><span style=\"color:#6CB6FF\"> 1</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    minutes_before </span><span style=\"color:#F47067\">INTEGER</span><span style=\"color:#F47067\"> DEFAULT</span><span style=\"color:#6CB6FF\"> 10</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    updated_at </span><span style=\"color:#F47067\">TIMESTAMP</span><span style=\"color:#F47067\"> DEFAULT</span><span style=\"color:#ADBAC7\"> CURRENT_TIMESTAMP</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">-- 時限マスタテーブル</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">CREATE</span><span style=\"color:#F47067\"> TABLE</span><span style=\"color:#DCBDFB\"> period_times</span><span style=\"color:#ADBAC7\"> (</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    period</span><span style=\"color:#F47067\"> INTEGER</span><span style=\"color:#F47067\"> PRIMARY KEY</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    start_time </span><span style=\"color:#F47067\">TEXT</span><span style=\"color:#F47067\"> NOT NULL</span><span style=\"color:#ADBAC7\">,  </span><span style=\"color:#768390\">-- 'HH:MM'</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    end_time </span><span style=\"color:#F47067\">TEXT</span><span style=\"color:#F47067\"> NOT NULL</span><span style=\"color:#768390\">     -- 'HH:MM'</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">-- 初期データ</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">INSERT INTO</span><span style=\"color:#ADBAC7\"> period_times </span><span style=\"color:#F47067\">VALUES</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    (</span><span style=\"color:#6CB6FF\">1</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'09:00'</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'10:30'</span><span style=\"color:#ADBAC7\">),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    (</span><span style=\"color:#6CB6FF\">2</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'10:45'</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'12:15'</span><span style=\"color:#ADBAC7\">),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    (</span><span style=\"color:#6CB6FF\">3</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'13:15'</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'14:45'</span><span style=\"color:#ADBAC7\">),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    (</span><span style=\"color:#6CB6FF\">4</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'15:00'</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'16:30'</span><span style=\"color:#ADBAC7\">),</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    (</span><span style=\"color:#6CB6FF\">5</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'16:45'</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">'18:15'</span><span style=\"color:#ADBAC7\">);</span></span></code></pre></figure>\n<br>\n<h3 id=\"リマインダーのスケジューリング\">リマインダーのスケジューリング</h3>\n<p><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>APScheduler</span></span></code></span> を使って定期的に通知をチェック・送信しています。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Python</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"python\" data-theme=\"github-dark-dimmed\"><code data-language=\"python\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">from</span><span style=\"color:#ADBAC7\"> apscheduler.schedulers.background </span><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> BackgroundScheduler</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">from</span><span style=\"color:#ADBAC7\"> datetime </span><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> datetime, timedelta</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> pytz</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">JST</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> pytz.timezone(</span><span style=\"color:#96D0FF\">\"Asia/Tokyo\"</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">def</span><span style=\"color:#DCBDFB\"> check_and_send_reminders</span><span style=\"color:#ADBAC7\">():</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"\"\"毎分実行：リマインダー対象の授業をチェックして通知\"\"\"</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    now </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> datetime.now(</span><span style=\"color:#6CB6FF\">JST</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    current_day </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> now.weekday()  </span><span style=\"color:#768390\"># 0=月曜</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">    # リマインダーが有効なユーザーを取得</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    users </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> get_users_with_reminder_enabled()</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">    for</span><span style=\"color:#ADBAC7\"> user </span><span style=\"color:#F47067\">in</span><span style=\"color:#ADBAC7\"> users:</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        minutes_before </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> user.minutes_before</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        target_time </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> now </span><span style=\"color:#F47067\">+</span><span style=\"color:#ADBAC7\"> timedelta(</span><span style=\"color:#F69D50\">minutes</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">minutes_before)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\">        # 対象時刻に開始する授業を検索</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        classes </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> get_classes_starting_at(</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">            user_id</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">user.user_id,</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">            day</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">current_day,</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">            time</span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\">target_time.strftime(</span><span style=\"color:#96D0FF\">\"%H:%M\"</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">        )</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">        for</span><span style=\"color:#6CB6FF\"> cls</span><span style=\"color:#F47067\"> in</span><span style=\"color:#ADBAC7\"> classes:</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">            send_reminder_notification(user.user_id, </span><span style=\"color:#6CB6FF\">cls</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#768390\"># スケジューラー設定</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">scheduler </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> BackgroundScheduler(</span><span style=\"color:#F69D50\">timezone</span><span style=\"color:#F47067\">=</span><span style=\"color:#96D0FF\">\"Asia/Tokyo\"</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">scheduler.add_job(</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    check_and_send_reminders,</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"cron\"</span><span style=\"color:#ADBAC7\">,</span></span>\n<span data-line=\"\"><span style=\"color:#F69D50\">    minute</span><span style=\"color:#F47067\">=</span><span style=\"color:#96D0FF\">\"*/1\"</span><span style=\"color:#768390\">  # 毎分実行</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">scheduler.start()</span></span></code></pre></figure>\n<br>\n<h3 id=\"タイムゾーン対応\">タイムゾーン対応</h3>\n<p>サーバーのタイムゾーンと日本時間のずれに注意が必要でした。<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>pytz</span></span></code></span> で明示的にJSTを指定しています。</p>\n<figure class=\"mdn-code\" data-rehype-pretty-code-figure=\"\"><div class=\"mdn-code-header\"><div class=\"mdn-code-lang\">Python</div><div class=\"mdn-code-actions\"><button type=\"button\" class=\"mdn-code-copy\" aria-label=\"Copy code to clipboard\">Copy</button></div></div><pre tabindex=\"0\" data-language=\"python\" data-theme=\"github-dark-dimmed\"><code data-language=\"python\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"><span data-line=\"\"><span style=\"color:#F47067\">from</span><span style=\"color:#ADBAC7\"> datetime </span><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> datetime</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">import</span><span style=\"color:#ADBAC7\"> pytz</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#6CB6FF\">JST</span><span style=\"color:#F47067\"> =</span><span style=\"color:#ADBAC7\"> pytz.timezone(</span><span style=\"color:#96D0FF\">\"Asia/Tokyo\"</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">def</span><span style=\"color:#DCBDFB\"> get_current_day_of_week</span><span style=\"color:#ADBAC7\">() -> </span><span style=\"color:#6CB6FF\">int</span><span style=\"color:#ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"\"\"現在の曜日を取得（0=月曜）\"\"\"</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    now </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> datetime.now(</span><span style=\"color:#6CB6FF\">JST</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#ADBAC7\"> now.weekday()</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"color:#F47067\">def</span><span style=\"color:#DCBDFB\"> get_today_date_string</span><span style=\"color:#ADBAC7\">() -> </span><span style=\"color:#6CB6FF\">str</span><span style=\"color:#ADBAC7\">:</span></span>\n<span data-line=\"\"><span style=\"color:#96D0FF\">    \"\"\"今日の日付を日本語で取得\"\"\"</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    now </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> datetime.now(</span><span style=\"color:#6CB6FF\">JST</span><span style=\"color:#ADBAC7\">)</span></span>\n<span data-line=\"\"><span style=\"color:#ADBAC7\">    days </span><span style=\"color:#F47067\">=</span><span style=\"color:#ADBAC7\"> [</span><span style=\"color:#96D0FF\">\"月\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"火\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"水\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"木\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"金\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"土\"</span><span style=\"color:#ADBAC7\">, </span><span style=\"color:#96D0FF\">\"日\"</span><span style=\"color:#ADBAC7\">]</span></span>\n<span data-line=\"\"><span style=\"color:#F47067\">    return</span><span style=\"color:#F47067\"> f</span><span style=\"color:#96D0FF\">\"</span><span style=\"color:#F47067\">{</span><span style=\"color:#ADBAC7\">now.month</span><span style=\"color:#F47067\">}</span><span style=\"color:#96D0FF\">月</span><span style=\"color:#F47067\">{</span><span style=\"color:#ADBAC7\">now.day</span><span style=\"color:#F47067\">}</span><span style=\"color:#96D0FF\">日（</span><span style=\"color:#F47067\">{</span><span style=\"color:#ADBAC7\">days[now.weekday()]</span><span style=\"color:#F47067\">}</span><span style=\"color:#96D0FF\">曜日）\"</span></span></code></pre></figure>\n<br>\n<h2 id=\"苦労したポイント\">苦労したポイント</h2>\n<br>\n<h3 id=\"1-gptによる柔軟なメッセージ解析\">1. GPTによる柔軟なメッセージ解析</h3>\n<p>ユーザーは様々な形式でメッセージを送ってきます：</p>\n<ul>\n<li><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>月曜の1限に数学を追加して</span></span></code></span></li>\n<li><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>月曜1限 数学 301教室</span></span></code></span></li>\n<li><span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>明日の2限は休講</span></span></code></span></li>\n</ul>\n<p>正規表現で全パターンに対応するのは困難でした。GPTを使うことで、<strong>自然言語のまま</strong>情報を抽出できるようになり、ユーザーは厳密なコマンド形式を覚える必要がなくなりました。</p>\n<p>ただし、GPTのレスポンスが常に期待通りのJSON形式とは限らないため、<strong>フォールバック処理</strong>（正規表現ベースの簡易パーサー）も実装しています。</p>\n<br>\n<h3 id=\"2-リマインダーの正確性\">2. リマインダーの正確性</h3>\n<p>1分単位でチェックしているため、タイミングがずれることがあります。現在は「X分前」ではなく「X分前〜X+1分前」の範囲でマッチするようにしています。</p>\n<br>\n<h3 id=\"3-複数ユーザー対応\">3. 複数ユーザー対応</h3>\n<p>各ユーザーの時間割を分離して管理する必要があります。<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>user_id</span></span></code></span>を必ずすべてのクエリに含め、データの混同を防いでいます。</p>\n<br>\n<h2 id=\"今後の改善予定\">今後の改善予定</h2>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> Flex Messageを使ったカード形式の表示</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 休講情報の登録機能</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 教室変更の通知機能</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> 時間割のエクスポート（テキスト形式）</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> リマインダーの通知タイミング変更機能</li>\n</ul>\n<br>\n<h2 id=\"開発で学んだこと\">開発で学んだこと</h2>\n<br>\n<h3 id=\"line-bot開発の基礎\">LINE Bot開発の基礎</h3>\n<ul>\n<li>Webhookの仕組みとHMAC SHA256署名検証の重要性</li>\n<li>Reply/Pushメッセージの違いと使い分け</li>\n<li>画像・ファイルのダウンロード処理</li>\n</ul>\n<br>\n<h3 id=\"gpt-apiの活用\">GPT APIの活用</h3>\n<ul>\n<li>プロンプトエンジニアリングの重要性</li>\n<li>JSON形式での出力指定（<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>response_format</span></span></code></span>）</li>\n<li>GPT-4oのビジョン機能を使った画像解析</li>\n<li>APIコスト管理とモデル選択（gpt-4o-mini vs gpt-4o）</li>\n</ul>\n<br>\n<h3 id=\"pythonでの非同期処理\">Pythonでの非同期処理</h3>\n<ul>\n<li>FastAPIと<span data-rehype-pretty-code-figure=\"\"><code data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"><span data-line=\"\"><span>BackgroundTasks</span></span></code></span>による非同期処理</li>\n<li>APSchedulerでの定期実行</li>\n<li>タイムゾーン（JST）の取り扱い</li>\n</ul>\n<br>\n<h2 id=\"まとめ\">まとめ</h2>\n<p>毎日使うツールを自分で作れるのはプログラミングの醍醐味だと思います。</p>\n<p>GPTを使うことで、正規表現では対応しきれない<strong>自然言語の解析</strong>が驚くほど簡単になりました。「月曜1限に数学追加」でも「明日の1コマ目、線形代数」でも、GPTが意図を理解してJSONに変換してくれます。</p>\n<p>画像からの時間割抽出も実装でき、スクリーンショットを送るだけで登録できるのは便利です。</p>\n<p>このBotを作ったおかげで、授業を忘れることがほぼなくなりました。</p>\n<br>\n<p>ソースコード: <a href=\"https://github.com/haroin57/timetable-bot\">haroin57/timetable-bot</a></p>"
  }
]