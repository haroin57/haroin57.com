{"slug":"timetable-bot","name":"timetable-bot","description":"LINE bot for managing timetables with GPT-powered natural language processing","language":"Python","tags":["LINE","Bot","GPT","OpenAI"],"url":"https://github.com/haroin57/timetable-bot","createdAt":"2025-12-19T13:03:35.305Z","updatedAt":"2025-12-19T13:03:35.305Z","markdown":"---\ntitle: \"timetable-bot - LINE時間割管理Botの解説\"\nsummary: \"PythonとLINE Messaging API、GPTを使った時間割管理Botについて\"\ndate: \"2025-12-18\"\nproduct: \"timetable-bot\"\ntags:\n- Python\n- LINE\n- Bot\n- GPT\n- OpenAI\n---\n\n## 目次\n\n<br />\n\n## はじめに\n\n大学の時間割を管理するために作ったLINE Botです。LINEで話しかけるだけで時間割の確認やリマインダー設定ができます。\n\n**GPTを使ってユーザーのメッセージを解析**し、自然な日本語から構造化データ（JSON）を抽出しています。これにより、厳密なコマンド形式を覚えなくても直感的に操作できます。\n\n毎日の授業管理をもっと楽にしたいという動機から開発しました。「今日の授業なんだっけ？」をLINEで即座に確認できるのが便利です。\n\n<br />\n\n## 技術スタック\n\n<br />\n\n### ランタイム・言語\n\n| 技術 | 説明 |\n|------|------|\n| **Python 3.11+** | メイン言語。型ヒント活用 |\n| **FastAPI** | 非同期対応Webフレームワーク |\n\n<br />\n\n### 外部サービス・API\n\n| 技術 | 説明 |\n|------|------|\n| **LINE Messaging API** | LINEとの連携 |\n| **LINE Messaging API SDK** | Python SDK |\n| **OpenAI API (GPT)** | メッセージ解析・JSON抽出 |\n\n<br />\n\n### データベース\n\n| 技術 | 説明 |\n|------|------|\n| **SQLite** | 軽量で扱いやすいDB |\n| **APScheduler** | リマインダーのスケジューリング |\n\n<br />\n\n## システムアーキテクチャ\n\n```mermaid\nflowchart TB\n    subgraph LINE[\"LINE Platform\"]\n        User[\"LINE App<br/>(User)\"]\n        API[\"Messaging API\"]\n    end\n\n    subgraph Server[\"FastAPI Server\"]\n        Webhook[\"Webhook Handler\"]\n        GPT[\"OpenAI GPT<br/>(メッセージ解析)\"]\n        Response[\"Response Builder\"]\n    end\n\n    subgraph Data[\"Data Layer\"]\n        Scheduler[\"APScheduler<br/>(リマインダー)\"]\n        DB[\"SQLite<br/>(Database)\"]\n    end\n\n    User <-->|メッセージ/画像| API\n    API -->|Webhook| Webhook\n    Webhook --> GPT\n    GPT -->|JSON抽出| Response\n    Response -->|返信| API\n    Scheduler -->|Push通知| API\n    GPT <--> DB\n    Scheduler <--> DB\n\n    style GPT fill:#134e4a,stroke:#5eead4,stroke-width:2px\n    style User fill:#1e3a5f,stroke:#60a5fa,stroke-width:2px\n    style DB fill:#3b2f4a,stroke:#a78bfa,stroke-width:2px\n```\n\n<br />\n\n## 主な機能\n\n<br />\n\n### 1. 時間割の登録\n\nテキストまたは画像で時間割を登録できます。GPTが自然言語を解析するため、厳密なコマンド形式を覚える必要はありません。\n\n<br />\n\n#### テキストで登録\n\n```\n月曜1限 解析学 C3 101\n火曜2限 英語 A棟201\n```\n\nのように送信すると、GPTが内容を解析して確認メッセージを返します：\n\n```\nこの内容で実行しますか？はい / いいえ\n```\n\n「はい」と答えると登録が完了し、結果が表示されます：\n\n```\n授業を追加しました。内訳は以下です。\n誤りがあれば「追加」「削除」「置換」で修正できます。\n\n- 月 09:00-10:30 解析学 / 教室: C3 101\n- 火 10:40-12:10 英語 / 教室: A棟201\n```\n\n<br />\n\n#### 画像で登録\n\n時間割の画像（スクリーンショットなど）を送信すると、GPT-4o Visionが内容を読み取って登録できます。\n\n```\n画像から時間割を登録しました。内訳は以下です。\n```\n\n<br />\n\n### 2. 時間割の編集・削除\n\n<br />\n\n#### 追加\n\n```\n追加 水曜3限 プログラミング PC室1\n```\n\n<br />\n\n#### 削除\n\n```\n削除 月曜1限\n```\n\n<br />\n\n#### 置換（修正・変更）\n\n```\n置換 月曜1限 微分積分 B棟301\n```\n\n`修正` や `変更` でも同様に動作します。\n\n<br />\n\n#### 教室の変更\n\n```\n教室 月曜1限 C棟102\n```\n\n`場所`、`location`、`room` でも同様に動作します。\n\n<br />\n\n#### 時刻の変更\n\n```\n時間 月曜1限 09:30 11:00\n```\n\n`時間変更`、`time`、`時刻` でも同様に動作します。\n\n<br />\n\n#### 全削除\n\n```\nリセット\n```\n\n`reset`、`クリア`、`clear` で全時間割を削除できます。\n\n<br />\n\n### 3. スケジュール表示\n\n<br />\n\n#### 一覧表示\n\n```\n一覧\n```\n\nと送信すると、登録済みの時間割を表示します：\n\n```\n- 月 09:00-10:30 解析学 / 教室: C3 101\n- 火 10:40-12:10 英語 / 教室: 未設定\n- 水 13:00-14:30 プログラミング / 教室: PC室1\n```\n\n`確認`、`時間割`、`schedule`、`list` でも同様に表示されます。\n\n<br />\n\n### 4. リマインダー通知\n\n授業開始**10分前**に自動でプッシュ通知を送信します（デフォルト設定）。\n\n時間割を登録すると、APSchedulerが各曜日・時刻にジョブを登録し、該当時刻に通知を送信します。\n\n<br />\n\n### 5. ヘルプ\n\n```\nヘルプ\n```\n\nと送信すると、使い方の一覧を表示します。`help`、`使い方` でも同様です。\n\n<br />\n\n## 実装詳細\n\n<br />\n\n### Webhook処理\n\nLINE Messaging APIからのWebhookを受け取り、HMAC SHA256で署名検証後、非同期でメッセージを処理します。\n\n```python\nfrom fastapi import FastAPI, Request, BackgroundTasks\nimport hmac\nimport hashlib\n\napp = FastAPI()\n\n@app.post(\"/callback\")\nasync def callback(request: Request, background_tasks: BackgroundTasks):\n    body = await request.body()\n    signature = request.headers.get(\"x-line-signature\")\n\n    # HMAC SHA256 署名検証\n    hash_value = hmac.new(\n        LINE_CHANNEL_SECRET.encode(),\n        body,\n        hashlib.sha256\n    ).digest()\n\n    if not hmac.compare_digest(signature, base64.b64encode(hash_value).decode()):\n        raise HTTPException(status_code=400)\n\n    # 非同期でイベント処理\n    events = json.loads(body)[\"events\"]\n    for event in events:\n        background_tasks.add_task(handle_event, event)\n\n    return \"OK\"\n```\n\n<br />\n\n### GPTによるメッセージ解析\n\n正規表現の代わりに**OpenAI GPTを使用**して、自然言語のメッセージから構造化されたJSONを抽出しています。これにより、ユーザーは厳密なコマンド形式を覚える必要がありません。\n\n```python\nfrom openai import OpenAI\n\ndef call_chatgpt_to_extract_schedule(timetable_text: str, model: str = \"gpt-4o-mini\"):\n    \"\"\"GPTを使って時間割情報をJSON形式で抽出\"\"\"\n\n    system_prompt = \"\"\"You are a strict JSON extractor for university timetables.\n    Extract schedule information and return ONLY valid JSON in this format:\n    {\n        \"action\": \"add\" | \"delete\" | \"replace\" | \"show\",\n        \"entries\": [\n            {\n                \"day\": \"月\" | \"火\" | \"水\" | \"木\" | \"金\",\n                \"period\": 1-5,\n                \"subject\": \"科目名\",\n                \"room\": \"教室名\"\n            }\n        ]\n    }\n    \"\"\"\n\n    client = OpenAI()\n    response = client.chat.completions.create(\n        model=model,\n        messages=[\n            {\"role\": \"system\", \"content\": system_prompt},\n            {\"role\": \"user\", \"content\": timetable_text}\n        ],\n        response_format={\"type\": \"json_object\"}\n    )\n\n    return json.loads(response.choices[0].message.content)\n```\n\n<br />\n\n### 画像からの時間割抽出\n\nGPT-4oのビジョン機能を使って、**時間割の画像からも情報を抽出**できます。\n\n```python\nimport base64\n\ndef call_chatgpt_to_extract_schedule_from_image(image_data: bytes):\n    \"\"\"画像から時間割情報を抽出\"\"\"\n\n    base64_image = base64.b64encode(image_data).decode()\n\n    client = OpenAI()\n    response = client.chat.completions.create(\n        model=\"gpt-4o\",\n        messages=[\n            {\n                \"role\": \"user\",\n                \"content\": [\n                    {\"type\": \"text\", \"text\": \"この時間割画像から授業情報をJSON形式で抽出してください\"},\n                    {\n                        \"type\": \"image_url\",\n                        \"image_url\": {\"url\": f\"data:image/jpeg;base64,{base64_image}\"}\n                    }\n                ]\n            }\n        ]\n    )\n\n    return json.loads(response.choices[0].message.content)\n```\n\n<br />\n\n### 時限から時刻へのマッピング\n\n「1限」などの表現を具体的な開始・終了時刻に変換します。\n\n```python\nDEFAULT_PERIOD_MAP = {\n    \"1\": {\"start\": \"09:00\", \"end\": \"10:30\"},\n    \"2\": {\"start\": \"10:40\", \"end\": \"12:10\"},\n    \"3\": {\"start\": \"13:00\", \"end\": \"14:30\"},\n    \"4\": {\"start\": \"14:40\", \"end\": \"16:10\"},\n    \"5\": {\"start\": \"16:20\", \"end\": \"17:50\"},\n}\n\ndef get_period_time(period: int) -> dict:\n    return DEFAULT_PERIOD_MAP.get(str(period), {})\n```\n\n<br />\n\n### データベース設計\n\nシンプルなテーブル構成で、ユーザーごとの時間割を管理しています。\n\n```sql\n-- 時間割テーブル\nCREATE TABLE timetable (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    user_id TEXT NOT NULL,\n    day_of_week INTEGER NOT NULL,  -- 0=月, 1=火, ..., 6=日\n    period INTEGER NOT NULL,        -- 1限, 2限, ...\n    subject TEXT NOT NULL,\n    room TEXT,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n\n    UNIQUE(user_id, day_of_week, period)\n);\n\n-- リマインダー設定テーブル\nCREATE TABLE reminder_settings (\n    user_id TEXT PRIMARY KEY,\n    enabled INTEGER DEFAULT 1,\n    minutes_before INTEGER DEFAULT 10,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\n-- 時限マスタテーブル\nCREATE TABLE period_times (\n    period INTEGER PRIMARY KEY,\n    start_time TEXT NOT NULL,  -- 'HH:MM'\n    end_time TEXT NOT NULL     -- 'HH:MM'\n);\n\n-- 初期データ\nINSERT INTO period_times VALUES\n    (1, '09:00', '10:30'),\n    (2, '10:45', '12:15'),\n    (3, '13:15', '14:45'),\n    (4, '15:00', '16:30'),\n    (5, '16:45', '18:15');\n```\n\n<br />\n\n### リマインダーのスケジューリング\n\n`APScheduler` を使って定期的に通知をチェック・送信しています。\n\n```python\nfrom apscheduler.schedulers.background import BackgroundScheduler\nfrom datetime import datetime, timedelta\nimport pytz\n\nJST = pytz.timezone(\"Asia/Tokyo\")\n\ndef check_and_send_reminders():\n    \"\"\"毎分実行：リマインダー対象の授業をチェックして通知\"\"\"\n    now = datetime.now(JST)\n    current_day = now.weekday()  # 0=月曜\n\n    # リマインダーが有効なユーザーを取得\n    users = get_users_with_reminder_enabled()\n\n    for user in users:\n        minutes_before = user.minutes_before\n        target_time = now + timedelta(minutes=minutes_before)\n\n        # 対象時刻に開始する授業を検索\n        classes = get_classes_starting_at(\n            user_id=user.user_id,\n            day=current_day,\n            time=target_time.strftime(\"%H:%M\")\n        )\n\n        for cls in classes:\n            send_reminder_notification(user.user_id, cls)\n\n# スケジューラー設定\nscheduler = BackgroundScheduler(timezone=\"Asia/Tokyo\")\nscheduler.add_job(\n    check_and_send_reminders,\n    \"cron\",\n    minute=\"*/1\"  # 毎分実行\n)\nscheduler.start()\n```\n\n<br />\n\n### タイムゾーン対応\n\nサーバーのタイムゾーンと日本時間のずれに注意が必要でした。`pytz` で明示的にJSTを指定しています。\n\n```python\nfrom datetime import datetime\nimport pytz\n\nJST = pytz.timezone(\"Asia/Tokyo\")\n\ndef get_current_day_of_week() -> int:\n    \"\"\"現在の曜日を取得（0=月曜）\"\"\"\n    now = datetime.now(JST)\n    return now.weekday()\n\ndef get_today_date_string() -> str:\n    \"\"\"今日の日付を日本語で取得\"\"\"\n    now = datetime.now(JST)\n    days = [\"月\", \"火\", \"水\", \"木\", \"金\", \"土\", \"日\"]\n    return f\"{now.month}月{now.day}日（{days[now.weekday()]}曜日）\"\n```\n\n<br />\n\n## 苦労したポイント\n\n<br />\n\n### 1. GPTによる柔軟なメッセージ解析\n\nユーザーは様々な形式でメッセージを送ってきます：\n\n- `月曜の1限に数学を追加して`\n- `月曜1限 数学 301教室`\n- `明日の2限は休講`\n\n正規表現で全パターンに対応するのは困難でした。GPTを使うことで、**自然言語のまま**情報を抽出できるようになり、ユーザーは厳密なコマンド形式を覚える必要がなくなりました。\n\nただし、GPTのレスポンスが常に期待通りのJSON形式とは限らないため、**フォールバック処理**（正規表現ベースの簡易パーサー）も実装しています。\n\n<br />\n\n### 2. リマインダーの正確性\n\n1分単位でチェックしているため、タイミングがずれることがあります。現在は「X分前」ではなく「X分前〜X+1分前」の範囲でマッチするようにしています。\n\n<br />\n\n### 3. 複数ユーザー対応\n\n各ユーザーの時間割を分離して管理する必要があります。`user_id`を必ずすべてのクエリに含め、データの混同を防いでいます。\n\n<br />\n\n## 今後の改善予定\n\n- [ ] Flex Messageを使ったカード形式の表示\n- [ ] 休講情報の登録機能\n- [ ] 教室変更の通知機能\n- [ ] 時間割のエクスポート（テキスト形式）\n- [ ] リマインダーの通知タイミング変更機能\n\n<br />\n\n## 開発で学んだこと\n\n<br />\n\n### LINE Bot開発の基礎\n\n- Webhookの仕組みとHMAC SHA256署名検証の重要性\n- Reply/Pushメッセージの違いと使い分け\n- 画像・ファイルのダウンロード処理\n\n<br />\n\n### GPT APIの活用\n\n- プロンプトエンジニアリングの重要性\n- JSON形式での出力指定（`response_format`）\n- GPT-4oのビジョン機能を使った画像解析\n- APIコスト管理とモデル選択（gpt-4o-mini vs gpt-4o）\n\n<br />\n\n### Pythonでの非同期処理\n\n- FastAPIと`BackgroundTasks`による非同期処理\n- APSchedulerでの定期実行\n- タイムゾーン（JST）の取り扱い\n\n<br />\n\n## まとめ\n\n毎日使うツールを自分で作れるのはプログラミングの醍醐味だと思います。\n\nGPTを使うことで、正規表現では対応しきれない**自然言語の解析**が驚くほど簡単になりました。「月曜1限に数学追加」でも「明日の1コマ目、線形代数」でも、GPTが意図を理解してJSONに変換してくれます。\n\n画像からの時間割抽出も実装でき、スクリーンショットを送るだけで登録できるのは便利です。\n\nこのBotを作ったおかげで、授業を忘れることがほぼなくなりました。\n\n<br />\n\nソースコード: [haroin57/timetable-bot](https://github.com/haroin57/timetable-bot)\n","html":""}